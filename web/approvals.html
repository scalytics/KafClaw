<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Approvals - KafClaw</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%2358a6ff'/%3E%3Cstop offset='100%25' stop-color='%23a855f7'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='4' y='14' width='56' height='40' rx='10' fill='url(%23g)'/%3E%3Crect x='12' y='6' width='6' height='12' rx='3' fill='%2358a6ff'/%3E%3Crect x='46' y='6' width='6' height='12' rx='3' fill='%23a855f7'/%3E%3Ccircle cx='22' cy='30' r='6' fill='%230d1117'/%3E%3Ccircle cx='22' cy='30' r='3' fill='%2358a6ff'/%3E%3Ccircle cx='42' cy='30' r='6' fill='%230d1117'/%3E%3Ccircle cx='42' cy='30' r='3' fill='%23a855f7'/%3E%3Crect x='20' y='40' width='24' height='4' rx='2' fill='%230d1117'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #0d1117;
            color: #c9d1d9;
        }

        .glass {
            background: rgba(22, 27, 34, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(48, 54, 61, 0.5);
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0d1117; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #484f58; }

        .pulse-ring {
            animation: pulse-ring 2s ease-out infinite;
        }
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.5); }
            70% { box-shadow: 0 0 0 12px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }
    </style>
</head>

<body class="min-h-screen">
    <div id="app" class="max-w-4xl mx-auto p-6">

        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-3">
                <a href="/timeline" class="flex items-center gap-1.5 text-gray-500 hover:text-blue-400 transition-colors text-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                    </svg>
                    Timeline
                </a>
                <div class="w-px h-5 bg-gray-700"></div>
                <div class="w-3 h-3 rounded-full" :class="approvals.length ? 'bg-amber-500 pulse-ring' : 'bg-green-500'"></div>
                <h1 class="text-xl font-bold text-white tracking-widest">TOOL <span class="text-amber-400">APPROVALS</span></h1>
            </div>
            <div class="text-xs text-gray-500">
                Polling every 5s &middot; {{ approvals.length }} pending
            </div>
        </div>

        <!-- Empty State -->
        <div v-if="!loading && approvals.length === 0" class="glass rounded-xl p-12 text-center">
            <div class="text-4xl mb-4">&#x2705;</div>
            <div class="text-lg text-gray-400 mb-2">No pending approvals</div>
            <div class="text-xs text-gray-600">Tier 2 tool calls that require authorization will appear here.</div>
        </div>

        <!-- Loading -->
        <div v-if="loading && approvals.length === 0" class="glass rounded-xl p-12 text-center">
            <div class="text-gray-500 animate-pulse">Loading...</div>
        </div>

        <!-- Approval Cards -->
        <div class="space-y-4">
            <div v-for="a in approvals" :key="a.approval_id"
                class="glass rounded-xl p-5 transition-all duration-300 hover:border-amber-800/50">

                <!-- Top row: tool + tier badge + age -->
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <span class="text-amber-400 font-bold text-lg">{{ a.tool }}</span>
                        <span class="px-2 py-0.5 rounded text-[10px] uppercase font-bold tracking-wider"
                            :class="a.tier >= 2 ? 'bg-red-900/40 text-red-400 border border-red-800' : 'bg-amber-900/40 text-amber-400 border border-amber-800'">
                            Tier {{ a.tier }}
                        </span>
                    </div>
                    <span class="text-xs text-gray-500" :title="a.created_at">{{ timeAgo(a.created_at) }}</span>
                </div>

                <!-- Details grid -->
                <div class="grid grid-cols-2 gap-x-6 gap-y-1 text-xs mb-4">
                    <div><span class="text-gray-500">Channel:</span> <span class="text-gray-300">{{ a.channel || '-' }}</span></div>
                    <div><span class="text-gray-500">Sender:</span> <span class="text-gray-300">{{ a.sender || '-' }}</span></div>
                    <div><span class="text-gray-500">Trace:</span> <span class="text-gray-300 font-mono">{{ a.trace_id || '-' }}</span></div>
                    <div><span class="text-gray-500">ID:</span> <span class="text-gray-300 font-mono">{{ a.approval_id }}</span></div>
                </div>

                <!-- Arguments -->
                <div v-if="a.arguments && a.arguments !== '{}'" class="mb-4">
                    <div class="text-[10px] uppercase text-gray-500 mb-1 tracking-wider">Arguments</div>
                    <pre class="bg-black/40 rounded-lg p-3 text-xs text-gray-300 overflow-x-auto max-h-32">{{ formatArgs(a.arguments) }}</pre>
                </div>

                <!-- Action buttons -->
                <div class="flex items-center gap-3">
                    <button @click="respond(a.approval_id, true)"
                        :disabled="responding[a.approval_id]"
                        class="px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all duration-200
                            bg-green-900/40 text-green-400 border border-green-800
                            hover:bg-green-800/60 hover:text-green-300
                            disabled:opacity-50 disabled:cursor-not-allowed">
                        <span v-if="responding[a.approval_id] === 'approve'" class="animate-pulse">Approving...</span>
                        <span v-else>Approve</span>
                    </button>
                    <button @click="respond(a.approval_id, false)"
                        :disabled="responding[a.approval_id]"
                        class="px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all duration-200
                            bg-red-900/40 text-red-400 border border-red-800
                            hover:bg-red-800/60 hover:text-red-300
                            disabled:opacity-50 disabled:cursor-not-allowed">
                        <span v-if="responding[a.approval_id] === 'deny'" class="animate-pulse">Denying...</span>
                        <span v-else>Deny</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div v-if="toast" class="fixed bottom-6 right-6 px-4 py-3 rounded-lg text-sm font-bold shadow-lg transition-all duration-300"
            :class="toast.type === 'success' ? 'bg-green-900/90 text-green-300 border border-green-700' : 'bg-red-900/90 text-red-300 border border-red-700'">
            {{ toast.message }}
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, onUnmounted } = Vue

        createApp({
            setup() {
                const approvals = ref([])
                const loading = ref(true)
                const responding = reactive({})
                const toast = ref(null)
                let pollTimer = null

                const loadApprovals = async () => {
                    try {
                        const res = await fetch('/api/v1/approvals/pending')
                        approvals.value = await res.json() || []
                    } catch (e) {
                        console.error('Failed to load approvals:', e)
                    } finally {
                        loading.value = false
                    }
                }

                const respond = async (id, approved) => {
                    responding[id] = approved ? 'approve' : 'deny'
                    try {
                        const res = await fetch(`/api/v1/approvals/${id}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ approved })
                        })
                        if (res.ok) {
                            showToast(approved ? 'Approved' : 'Denied', 'success')
                            // Remove from list immediately
                            approvals.value = approvals.value.filter(a => a.approval_id !== id)
                        } else {
                            showToast('Failed to respond', 'error')
                        }
                    } catch (e) {
                        showToast('Network error', 'error')
                    } finally {
                        delete responding[id]
                    }
                }

                const showToast = (message, type) => {
                    toast.value = { message, type }
                    setTimeout(() => { toast.value = null }, 3000)
                }

                const timeAgo = (dateStr) => {
                    if (!dateStr) return ''
                    const now = Date.now()
                    const then = new Date(dateStr + 'Z').getTime()
                    const seconds = Math.floor((now - then) / 1000)
                    if (seconds < 5) return 'just now'
                    if (seconds < 60) return `${seconds}s ago`
                    const minutes = Math.floor(seconds / 60)
                    if (minutes < 60) return `${minutes}m ago`
                    return `${Math.floor(minutes / 60)}h ago`
                }

                const formatArgs = (argsStr) => {
                    try {
                        return JSON.stringify(JSON.parse(argsStr), null, 2)
                    } catch {
                        return argsStr
                    }
                }

                onMounted(() => {
                    loadApprovals()
                    pollTimer = setInterval(loadApprovals, 5000)
                })

                onUnmounted(() => {
                    if (pollTimer) clearInterval(pollTimer)
                })

                return { approvals, loading, responding, toast, respond, timeAgo, formatArgs }
            }
        }).mount('#app')
    </script>
</body>

</html>
