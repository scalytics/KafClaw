<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QMD Timeline - KafClaw</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%2358a6ff'/%3E%3Cstop offset='100%25' stop-color='%23a855f7'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='4' y='14' width='56' height='40' rx='10' fill='url(%23g)'/%3E%3Crect x='12' y='6' width='6' height='12' rx='3' fill='%2358a6ff'/%3E%3Crect x='46' y='6' width='6' height='12' rx='3' fill='%23a855f7'/%3E%3Ccircle cx='22' cy='30' r='6' fill='%230d1117'/%3E%3Ccircle cx='22' cy='30' r='3' fill='%2358a6ff'/%3E%3Ccircle cx='42' cy='30' r='6' fill='%230d1117'/%3E%3Ccircle cx='42' cy='30' r='3' fill='%23a855f7'/%3E%3Crect x='20' y='40' width='24' height='4' rx='2' fill='%230d1117'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dagre-d3@0.6.4/dist/dagre-d3.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #0d1117;
            color: #c9d1d9;
        }

        .glass {
            background: rgba(22, 27, 34, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(48, 54, 61, 0.5);
        }

        .timeline-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #30363d;
            transform: translateX(-50%);
            z-index: -1;
        }

        .identity-repo-icon {
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), rgba(168,85,247,0.45) 35%, rgba(128,0,255,0.9) 70%);
            box-shadow: none;
            transition: box-shadow 0.3s ease;
        }
        .identity-repo-icon.active {
            box-shadow: 0 0 16px rgba(255,255,255,0.7), 0 0 32px rgba(168,85,247,0.6);
        }

        .work-repo-icon {
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), rgba(34,197,94,0.45) 35%, rgba(22,163,74,0.9) 70%);
            box-shadow: none;
            transition: box-shadow 0.3s ease;
        }
        .work-repo-icon.active {
            box-shadow: 0 0 16px rgba(255,255,255,0.7), 0 0 32px rgba(34,197,94,0.6);
        }

        .trace-icon {
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), rgba(168,85,247,0.45) 35%, rgba(251,146,60,0.9) 70%);
            box-shadow: none;
            transition: box-shadow 0.3s ease;
        }
        .trace-icon.active {
            box-shadow: 0 0 16px rgba(255,255,255,0.7), 0 0 32px rgba(251,146,60,0.6);
        }

        .tasks-icon {
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), rgba(6,182,212,0.45) 35%, rgba(8,145,178,0.9) 70%);
            box-shadow: none;
            transition: box-shadow 0.3s ease;
        }
        .tasks-icon.active {
            box-shadow: 0 0 16px rgba(255,255,255,0.7), 0 0 32px rgba(6,182,212,0.6);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0d1117;
        }

        ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #58a6ff;
        }
        [v-cloak] {
            display: none !important;
        }

        /* Trace graph styles */
        .trace-graph-container {
            background: #0d1117;
            overflow: hidden;
        }
        .trace-graph-container svg {
            width: 100%;
            height: 100%;
        }
        .trace-graph-container .node rect {
            rx: 6;
            ry: 6;
            stroke-width: 2;
        }
        .trace-graph-container .node.type-INBOUND rect { fill: #1e3a5f; stroke: #58a6ff; }
        .trace-graph-container .node.type-LLM rect { fill: #2d1b4e; stroke: #a855f7; }
        .trace-graph-container .node.type-TOOL rect { fill: #3d2a0a; stroke: #fb923c; }
        .trace-graph-container .node.type-OUTBOUND rect { fill: #0a3d1a; stroke: #22c55e; }
        .trace-graph-container .node.type-POLICY rect { fill: #3d0a0a; stroke: #ef4444; }
        .trace-graph-container .node.type-EVENT rect { fill: #1a1a2e; stroke: #6366f1; }
        .trace-graph-container .node.remote rect { stroke-dasharray: 5,3; }
        .trace-graph-container .node.selected rect { stroke-width: 3; filter: drop-shadow(0 0 8px currentColor); }
        .trace-graph-container .node text { fill: #c9d1d9; font-size: 11px; font-family: 'JetBrains Mono', monospace; }
        .trace-graph-container .edgePath path { stroke: #30363d; stroke-width: 1.5; fill: none; }
        .trace-graph-container .edgePath marker { fill: #30363d; }

        .group-icon {
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), rgba(251,191,36,0.45) 35%, rgba(245,158,11,0.9) 70%);
            box-shadow: none;
            transition: box-shadow 0.3s ease;
        }
        .group-icon.active {
            box-shadow: 0 0 16px rgba(255,255,255,0.7), 0 0 32px rgba(245,158,11,0.6);
        }

        .memory-icon {
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), rgba(168,85,247,0.45) 35%, rgba(103,232,249,0.9) 70%);
            box-shadow: none;
            transition: box-shadow 0.3s ease;
        }
        .memory-icon.active {
            box-shadow: 0 0 16px rgba(255,255,255,0.7), 0 0 32px rgba(168,85,247,0.6);
        }

        .mem-gauge-bar {
            height: 6px;
            border-radius: 3px;
            background: #21262d;
            overflow: hidden;
        }
        .mem-gauge-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.4s ease;
        }

    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">
    <div id="app" v-cloak class="flex flex-col h-full">
        <!-- Header -->
        <header class="glass z-10 shadow-lg">
            <!-- Top Tier: Brand, Panel Orbs, Utilities -->
            <div class="px-4 py-2.5 flex items-center justify-between">
                <!-- Breadcrumb Nav + Brand + Status -->
                <div class="flex items-center gap-3">
                    <!-- Back: Mode Selector -->
                    <a href="javascript:void(0)" @click="switchMode" class="flex items-center gap-1.5 text-gray-500 hover:text-blue-400 transition-colors text-xs">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                        </svg>
                        Mode
                    </a>
                    <div class="w-px h-5 bg-gray-700"></div>
                    <!-- Current: Timeline -->
                    <div class="w-3 h-3 rounded-full animate-pulse" :class="silentMode ? 'bg-yellow-500' : 'bg-green-500'"></div>
                    <h1 class="text-xl font-bold text-white tracking-widest">QMD <span class="text-blue-400">MEMORY</span></h1>
                    <div class="flex items-center gap-2 ml-2 px-3 py-1 rounded-lg border transition-all duration-300"
                        :class="silentMode ? 'bg-yellow-900/30 border-yellow-700' : 'bg-green-900/20 border-green-800'">
                        <span class="text-[10px] uppercase font-bold tracking-wider"
                            :class="silentMode ? 'text-yellow-400' : 'text-green-400'">
                            {{ silentMode ? 'SILENT' : 'LIVE' }}
                        </span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" v-model="silentMode" @change="toggleSilent" class="sr-only peer">
                            <div class="w-8 h-4 rounded-full peer transition-colors duration-300"
                                :class="silentMode ? 'bg-yellow-600' : 'bg-green-600'">
                                <div class="absolute top-[2px] left-[2px] w-3 h-3 bg-white rounded-full transition-transform duration-300"
                                    :class="silentMode ? 'translate-x-4' : ''"></div>
                            </div>
                        </label>
                    </div>
                    <template v-if="appMode !== 'standalone'">
                        <div class="w-px h-5 bg-gray-700"></div>
                        <!-- Forward: Approvals -->
                        <a href="/approvals" class="flex items-center gap-1.5 text-gray-500 hover:text-amber-400 transition-colors text-xs">
                            Approvals
                        </a>
                        <div class="w-px h-5 bg-gray-700"></div>
                        <!-- Forward: Group -->
                        <a href="/group" class="flex items-center gap-1.5 text-gray-500 hover:text-amber-400 transition-colors text-xs">
                            Group
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                            </svg>
                        </a>
                    </template>
                </div>

                <!-- Panel Orbs -->
                <div class="flex items-center gap-3">
                    <div class="group relative">
                        <button @click="toggleIdentityPanel" title="Identity Repo"
                            class="w-9 h-9 rounded-full flex items-center justify-center identity-repo-icon transition-all duration-300"
                            :class="{ active: identityPanelVisible }">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.85)]" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 .5C5.7.5.5 5.7.5 12c0 5.1 3.3 9.4 7.9 10.9.6.1.8-.3.8-.6v-2.1c-3.2.7-3.9-1.4-3.9-1.4-.5-1.2-1.2-1.5-1.2-1.5-1-.7.1-.7.1-.7 1.1.1 1.7 1.1 1.7 1.1 1 .1.8 2.2 2.9 2.3.1-.7.4-1.2.7-1.5-2.6-.3-5.4-1.3-5.4-6 0-1.3.5-2.4 1.2-3.2-.1-.3-.5-1.5.1-3.1 0 0 1-.3 3.3 1.2 1-.3 2-.4 3-.4s2 .1 3 .4c2.3-1.5 3.3-1.2 3.3-1.2.6 1.6.2 2.8.1 3.1.8.8 1.2 1.9 1.2 3.2 0 4.7-2.8 5.7-5.4 6 .4.3.8 1 .8 2.1v3.1c0 .3.2.7.8.6 4.6-1.5 7.9-5.8 7.9-10.9C23.5 5.7 18.3.5 12 .5z"/>
                            </svg>
                        </button>
                        <span class="pointer-events-none absolute left-1/2 -translate-x-1/2 top-full mt-1 whitespace-nowrap rounded bg-gray-800 border border-gray-600 px-2 py-0.5 text-[10px] text-purple-300 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-40">Identity Repo</span>
                    </div>

                    <!-- Work Repo Orb + Popover -->
                    <div class="relative group">
                        <button @click="toggleRepoPanel" @contextmenu.prevent="repoSelectorOpen = !repoSelectorOpen" title="Work Repo (right-click: switch repo)"
                            class="w-9 h-9 rounded-full flex items-center justify-center work-repo-icon transition-all duration-300"
                            :class="{ active: repoPanelVisible }">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white drop-shadow-[0_0_8px_rgba(34,197,94,0.85)]" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 .5C5.7.5.5 5.7.5 12c0 5.1 3.3 9.4 7.9 10.9.6.1.8-.3.8-.6v-2.1c-3.2.7-3.9-1.4-3.9-1.4-.5-1.2-1.2-1.5-1.2-1.5-1-.7.1-.7.1-.7 1.1.1 1.7 1.1 1.7 1.1 1 .1.8 2.2 2.9 2.3.1-.7.4-1.2.7-1.5-2.6-.3-5.4-1.3-5.4-6 0-1.3.5-2.4 1.2-3.2-.1-.3-.5-1.5.1-3.1 0 0 1-.3 3.3 1.2 1-.3 2-.4 3-.4s2 .1 3 .4c2.3-1.5 3.3-1.2 3.3-1.2.6 1.6.2 2.8.1 3.1.8.8 1.2 1.9 1.2 3.2 0 4.7-2.8 5.7-5.4 6 .4.3.8 1 .8 2.1v3.1c0 .3.2.7.8.6 4.6-1.5 7.9-5.8 7.9-10.9C23.5 5.7 18.3.5 12 .5z"/>
                            </svg>
                        </button>
                        <span class="pointer-events-none absolute left-1/2 -translate-x-1/2 top-full mt-1 whitespace-nowrap rounded bg-gray-800 border border-gray-600 px-2 py-0.5 text-[10px] text-green-400 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-40">Work Repo</span>
                        <!-- Repo Selector Popover -->
                        <div v-if="repoSelectorOpen"
                            class="absolute top-full left-1/2 -translate-x-1/2 mt-2 w-80 glass rounded-xl border border-gray-700 p-3 z-30 shadow-xl">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-xs uppercase text-gray-400 tracking-wider">Work Repo</div>
                                <button @click="repoSelectorOpen = false" class="text-gray-500 hover:text-white text-xs">✕</button>
                            </div>
                            <select v-model="selectedRepoPath"
                                :class="selectedRepoPath && selectedRepoPath !== defaultWorkRepoPath ? 'border-blue-500' : 'border-gray-700'"
                                class="bg-[#0d1117] border rounded px-2 py-1 text-xs text-white w-full focus:outline-none focus:border-blue-500 mb-2">
                                <option value="">Select repo</option>
                                <option v-for="repo in repoOptions" :key="repo.path" :value="repo.path" :title="repo.path">{{ repo.name }}</option>
                            </select>
                            <div class="flex items-center gap-2 mb-2">
                                <button @click="useSelectedRepo"
                                    class="text-[10px] px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">Use Selected</button>
                                <button @click="useDefaultRepo"
                                    :class="activeRepoChoice === 'default' ? 'border border-blue-500' : 'border border-gray-700'"
                                    class="text-[10px] px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">Default</button>
                                <button @click="loadRepoOptions"
                                    class="text-[10px] px-2 py-1 rounded bg-gray-800 hover:bg-gray-700 text-white">Rescan</button>
                            </div>
                            <div v-if="selectedRepoPath" class="text-[10px] text-gray-500 truncate mb-1" :title="selectedRepoPath">{{ selectedRepoPath }}</div>
                            <div v-if="repoScanStatus" class="text-[10px] text-gray-400 mb-2">{{ repoScanStatus }}</div>
                            <div class="flex gap-2 text-[10px] text-gray-400">
                                <div class="flex-1 px-2 py-1 rounded bg-[#0d1117] border border-gray-800">
                                    <div class="text-[9px] uppercase text-gray-500">Work</div>
                                    <div class="break-all text-gray-300">{{ workRepoPath || 'Not set' }}</div>
                                </div>
                                <div class="flex-1 px-2 py-1 rounded bg-[#0d1117] border border-gray-800">
                                    <div class="text-[9px] uppercase text-gray-500">System</div>
                                    <div class="break-all text-gray-300">{{ identityRepoPath || 'Not set' }}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="relative group">
                        <button @click="toggleTracePanel" title="Trace Viewer"
                            class="w-9 h-9 rounded-full flex items-center justify-center trace-icon transition-all duration-300"
                            :class="{ active: tracePanelVisible }">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white drop-shadow-[0_0_8px_rgba(251,146,60,0.85)]" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M3 3h4v4H3V3zm7 7h4v4h-4v-4zm7 7h4v4h-4v-4zM5 7h2v4h4v2H5V7zm7 7h2v4h4v2h-6v-6z"/>
                            </svg>
                        </button>
                        <span class="pointer-events-none absolute left-1/2 -translate-x-1/2 top-full mt-1 whitespace-nowrap rounded bg-gray-800 border border-gray-600 px-2 py-0.5 text-[10px] text-orange-400 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-40">Trace Viewer</span>
                    </div>

                    <div class="relative group">
                        <button @click="toggleTasksPanel" title="Tasks"
                            class="w-9 h-9 rounded-full flex items-center justify-center tasks-icon transition-all duration-300"
                            :class="{ active: tasksPanelVisible }">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white drop-shadow-[0_0_8px_rgba(6,182,212,0.85)]" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                        </button>
                        <span class="pointer-events-none absolute left-1/2 -translate-x-1/2 top-full mt-1 whitespace-nowrap rounded bg-gray-800 border border-gray-600 px-2 py-0.5 text-[10px] text-cyan-400 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-40">Tasks</span>
                    </div>

                    <!-- Group Orb -->
                    <div v-if="appMode !== 'standalone' && groupStatus.active" class="relative group" @click="toggleGroupPanel">
                        <div class="w-9 h-9 rounded-full flex items-center justify-center group-icon transition-all duration-300"
                            :class="{ active: groupPanelVisible }">
                            <span class="text-xs font-bold text-black">G</span>
                        </div>
                        <span class="pointer-events-none absolute left-1/2 -translate-x-1/2 top-full mt-1 whitespace-nowrap rounded bg-gray-800 border border-gray-600 px-2 py-0.5 text-[10px] text-amber-400 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-40">Group: {{ groupStatus.group_name }}</span>
                    </div>

                    <!-- Memory Orb -->
                    <div class="relative group">
                        <button @click="toggleMemoryPanel" title="Memory Manager"
                            class="w-9 h-9 rounded-full flex items-center justify-center memory-icon transition-all duration-300"
                            :class="{ active: memoryPanelVisible }">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white drop-shadow-[0_0_8px_rgba(168,85,247,0.85)]" viewBox="0 0 24 24" fill="currentColor">
                                <rect x="6" y="4" width="12" height="16" rx="2" fill="currentColor" opacity="0.7"/>
                                <rect x="9" y="7" width="6" height="6" rx="1" fill="#0d1117"/>
                                <line x1="3" y1="8" x2="6" y2="8" stroke="currentColor" stroke-width="1.5"/>
                                <line x1="3" y1="12" x2="6" y2="12" stroke="currentColor" stroke-width="1.5"/>
                                <line x1="3" y1="16" x2="6" y2="16" stroke="currentColor" stroke-width="1.5"/>
                                <line x1="18" y1="8" x2="21" y2="8" stroke="currentColor" stroke-width="1.5"/>
                                <line x1="18" y1="12" x2="21" y2="12" stroke="currentColor" stroke-width="1.5"/>
                                <line x1="18" y1="16" x2="21" y2="16" stroke="currentColor" stroke-width="1.5"/>
                            </svg>
                        </button>
                        <span class="pointer-events-none absolute left-1/2 -translate-x-1/2 top-full mt-1 whitespace-nowrap rounded bg-gray-800 border border-gray-600 px-2 py-0.5 text-[10px] text-purple-300 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-40">Memory: {{ memoryTotalChunks.toLocaleString() }} chunks</span>
                    </div>
                </div>

                <!-- Utilities -->
                <div class="flex items-center gap-1">
                    <!-- Clipboard Gadget -->
                    <div class="relative">
                        <button @click="toggleClipboard" title="Clipboard"
                            class="p-2 rounded-lg text-gray-400 hover:text-white hover:bg-white/5 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5h6m-6 4h6m-6 4h6M8 3h8a2 2 0 012 2v16a2 2 0 01-2 2H8a2 2 0 01-2-2V5a2 2 0 012-2z" />
                            </svg>
                        </button>
                        <div v-if="clipboardOpen"
                            class="absolute right-0 mt-2 w-[28rem] glass rounded-xl border border-gray-700 p-3 z-20 shadow-xl">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-xs uppercase text-gray-400">Clipboard</div>
                                <button @click="toggleClipboard" class="text-gray-500 hover:text-white text-xs">✕</button>
                            </div>
                            <div class="flex items-center gap-2 mb-2">
                                <button @click="selectAllClipboard"
                                    class="text-[10px] px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">Select All</button>
                                <button @click="clearClipboard"
                                    class="text-[10px] px-2 py-1 rounded bg-red-700 hover:bg-red-600 text-white">Clear</button>
                                <button @click="deleteSelectedClipboard"
                                    class="text-[10px] px-2 py-1 rounded bg-yellow-700 hover:bg-yellow-600 text-white">Delete Selected</button>
                                <button @click="copySelectedClipboard"
                                    class="text-[10px] px-2 py-1 rounded bg-blue-700 hover:bg-blue-600 text-white">Copy Selected</button>
                            </div>
                            <div class="max-h-64 overflow-y-auto border border-gray-800 rounded">
                                <div v-if="clipboardItems.length === 0" class="p-3 text-xs text-gray-500">Clipboard empty</div>
                                <div v-for="item in clipboardItems" :key="item.id"
                                    class="p-2 border-b border-gray-800 flex items-start gap-2">
                                    <input type="checkbox" v-model="clipboardSelected" :value="item.id"
                                        class="mt-1 accent-blue-500">
                                    <div class="flex-1">
                                        <div class="text-[10px] text-gray-500">{{ new Date(item.ts).toLocaleTimeString() }}</div>
                                        <div class="text-xs whitespace-pre-wrap">{{ item.text }}</div>
                                    </div>
                                    <button @click="removeClipboardItem(item.id)"
                                        class="text-gray-500 hover:text-white text-xs">✕</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="w-px h-5 bg-gray-700"></div>

                    <!-- Config Manager -->
                    <button @click="openConfig" title="Config Manager"
                        class="p-2 rounded-lg text-gray-400 hover:text-white hover:bg-white/5 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19.14,12.94a7.49,7.49,0,0,0,.05-.94,7.49,7.49,0,0,0-.05-.94l2.11-1.65a.5.5,0,0,0,.12-.64l-2-3.46a.5.5,0,0,0-.6-.22l-2.49,1a7.23,7.23,0,0,0-1.63-.94l-.38-2.65A.5.5,0,0,0,11.73,1H8.27a.5.5,0,0,0-.49.42L7.4,4.07a7.23,7.23,0,0,0-1.63.94l-2.49-1a.5.5,0,0,0-.6.22l-2,3.46a.5.5,0,0,0,.12.64L2.9,11.06a7.49,7.49,0,0,0-.05.94,7.49,7.49,0,0,0,.05.94L.8,14.59a.5.5,0,0,0-.12.64l2,3.46a.5.5,0,0,0,.6.22l2.49-1a7.23,7.23,0,0,0,1.63.94l.38,2.65a.5.5,0,0,0,.49.42h3.46a.5.5,0,0,0,.49-.42l.38-2.65a7.23,7.23,0,0,0,1.63-.94l2.49,1a.5.5,0,0,0,.6-.22l2-3.46a.5.5,0,0,0-.12-.64ZM10,15.5A3.5,3.5,0,1,1,13.5,12,3.5,3.5,0,0,1,10,15.5Z"/>
                        </svg>
                    </button>

                </div>
            </div>

            <!-- Bottom Tier: Filters -->
            <div class="px-4 py-1.5 border-t border-gray-800/50 flex items-center gap-3">
                <select v-model="selectedUser"
                    class="bg-[#0d1117] border border-gray-700 rounded px-2 py-1 text-xs focus:outline-none focus:border-blue-500 text-white">
                    <option value="">All timelines</option>
                    <option v-for="user in senders" :key="user" :value="user">{{ user }}</option>
                </select>

                <select v-model="authFilter"
                    class="bg-[#0d1117] border border-gray-700 rounded px-2 py-1 text-xs focus:outline-none focus:border-blue-500 text-white">
                    <option value="all">All messages</option>
                    <option value="authorized">Authorized</option>
                    <option value="unauthorized">Unauthorized</option>
                </select>

                <div class="w-px h-4 bg-gray-700"></div>

                <label class="flex items-center gap-2 cursor-pointer px-2 py-1 rounded hover:bg-white/5 transition-colors">
                    <input type="checkbox" v-model="showTechnical" class="sr-only peer">
                    <div class="relative w-8 h-4 rounded-full peer transition-colors duration-300"
                        :class="showTechnical ? 'bg-blue-600' : 'bg-gray-600'">
                        <div class="absolute top-[2px] left-[2px] w-3 h-3 bg-white rounded-full transition-transform duration-300"
                            :class="showTechnical ? 'translate-x-4' : ''"></div>
                    </div>
                    <span class="text-[10px] uppercase text-gray-400">{{ showTechnical ? 'Detailed' : 'User' }}</span>
                </label>
            </div>
        </header>

        <div v-if="configOpen" class="fixed inset-0 z-50 flex items-start justify-center pt-8">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="closeConfig"></div>
            <div class="relative w-[min(720px,92vw)] glass border border-gray-700 rounded-2xl shadow-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="text-sm font-bold text-blue-400 tracking-widest">CONFIG MANAGER</div>
                    <button @click="closeConfig"
                        class="text-xs px-2 py-1 rounded bg-[#3b1118] hover:bg-[#6b1f2c] text-white shadow-none hover:shadow-[0_0_14px_rgba(200,80,110,0.85)]">✕</button>
                </div>
                <!-- Tabs -->
                <div class="flex gap-1 mb-4 border-b border-gray-700 pb-px">
                    <button v-for="tab in configTabs" :key="tab.id" @click="configTab = tab.id"
                        :class="configTab === tab.id
                            ? 'text-white border-b-2 border-blue-400 bg-blue-400/10'
                            : 'text-gray-500 hover:text-gray-300 border-b-2 border-transparent'"
                        class="px-3 py-1.5 text-[11px] font-semibold tracking-wider uppercase transition-all rounded-t">
                        {{ tab.label }}
                    </button>
                </div>
                <!-- Tab: Paths -->
                <div v-show="configTab === 'paths'" class="grid gap-3">
                    <label class="text-xs text-gray-400 uppercase">Bot Repo Path (Identity / System)</label>
                    <input v-model="cfgBotRepoPath" placeholder="Bot system repo path"
                        class="bg-[#0d1117] border border-gray-700 rounded px-3 py-2 text-xs text-white focus:outline-none focus:border-blue-500" />
                    <label class="text-xs text-gray-400 uppercase">Default Work Repo Path</label>
                    <input v-model="cfgDefaultWorkRepoPath" placeholder="Default work repo path"
                        class="bg-[#0d1117] border border-gray-700 rounded px-3 py-2 text-xs text-white focus:outline-none focus:border-blue-500" />
                    <label class="text-xs text-gray-400 uppercase">Default Repo Search Path</label>
                    <input v-model="cfgDefaultRepoSearchPath" placeholder="Repo search root"
                        class="bg-[#0d1117] border border-gray-700 rounded px-3 py-2 text-xs text-white focus:outline-none focus:border-blue-500" />
                </div>
                <!-- Tab: WhatsApp -->
                <div v-show="configTab === 'whatsapp'" class="grid gap-3">
                    <label class="text-xs text-gray-400 uppercase">Pairing Token</label>
                    <input v-model="cfgWhatsAppToken" placeholder="Shared token"
                        class="bg-[#0d1117] border border-gray-700 rounded px-3 py-2 text-xs text-white focus:outline-none focus:border-purple-500" />
                    <label class="text-xs text-gray-400 uppercase">Allowlist (one per line)</label>
                    <textarea v-model="cfgWhatsAppAllowlist" rows="3" placeholder="123456789@s.whatsapp.net"
                        class="bg-[#0d1117] border border-gray-700 rounded px-3 py-2 text-xs text-white focus:outline-none focus:border-purple-500"></textarea>
                    <label class="text-xs text-gray-400 uppercase">Denylist (one per line)</label>
                    <textarea v-model="cfgWhatsAppDenylist" rows="3" placeholder="123456789@s.whatsapp.net"
                        class="bg-[#0d1117] border border-gray-700 rounded px-3 py-2 text-xs text-white focus:outline-none focus:border-purple-500"></textarea>
                    <label class="text-xs text-gray-400 uppercase">Pending (token submitted)</label>
                    <textarea v-model="cfgWhatsAppPending" rows="2" readonly
                        class="bg-[#0d1117] border border-gray-700 rounded px-3 py-2 text-xs text-gray-400"></textarea>
                    <div class="flex gap-2">
                        <button @click="approvePending"
                            class="text-xs px-2 py-1 rounded bg-purple-700 hover:bg-purple-600 text-white">Approve Pending</button>
                        <button @click="denyPending"
                            class="text-xs px-2 py-1 rounded bg-red-700 hover:bg-red-600 text-white">Blacklist Pending</button>
                        <button @click="clearPending"
                            class="text-xs px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">Clear Pending</button>
                    </div>
                </div>
                <!-- Tab: Policy -->
                <div v-show="configTab === 'policy'" class="grid gap-3">
                    <label class="text-xs text-gray-400 uppercase">Daily Token Limit (0 = unlimited)</label>
                    <input v-model="cfgDailyTokenLimit" type="number" min="0" placeholder="0"
                        class="bg-[#0d1117] border border-gray-700 rounded px-3 py-2 text-xs text-white focus:outline-none focus:border-cyan-500" />
                    <label class="text-xs text-gray-400 uppercase">Max Auto-Approve Tier (0=read, 1=write, 2=exec)</label>
                    <select v-model="cfgMaxAutoTier"
                        class="bg-[#0d1117] border border-gray-700 rounded px-3 py-2 text-xs text-white focus:outline-none focus:border-cyan-500">
                        <option value="0">0 - Read Only</option>
                        <option value="1">1 - Read + Write</option>
                        <option value="2">2 - All (incl. Shell Exec)</option>
                    </select>
                    <label class="text-xs text-gray-400 uppercase">Default Auth Filter</label>
                    <select v-model="cfgAuthFilterDefault"
                        class="bg-[#0d1117] border border-gray-700 rounded px-3 py-2 text-xs text-white focus:outline-none focus:border-cyan-500">
                        <option value="authorized">Authorized</option>
                        <option value="unauthorized">Unauthorized</option>
                        <option value="all">All</option>
                    </select>
                </div>
                <!-- Tab: Integrations -->
                <div v-show="configTab === 'integrations'" class="grid gap-3">
                    <label class="text-xs text-gray-400 uppercase">KafScale LFS Proxy URL</label>
                    <input v-model="cfgKafScaleProxyUrl" placeholder="https://..."
                        class="bg-[#0d1117] border border-gray-700 rounded px-3 py-2 text-xs text-white focus:outline-none focus:border-blue-500" />
                </div>
                <!-- Footer -->
                <div class="flex items-center justify-end gap-2 mt-5">
                    <button @click="closeConfig"
                        class="text-xs px-3 py-2 rounded bg-gray-700 hover:bg-gray-600 text-white">Cancel</button>
                    <button @click="saveConfig"
                        class="text-xs px-3 py-2 rounded bg-blue-700 hover:bg-blue-600 text-white">Save</button>
                </div>
                <div v-if="configStatus" class="mt-3 text-[11px] text-gray-400">{{ configStatus }}</div>
            </div>
        </div>

        <!-- Tasks Panel — modal overlay -->
        <div v-if="tasksPanelVisible" class="fixed inset-0 z-50 flex items-center justify-center"
            @click.self="hideTasksPanel">
            <div class="glass rounded-xl border border-gray-700 overflow-hidden shadow-2xl"
                style="width: 640px; max-width: 95vw; height: 600px; max-height: 85vh;">
                <!-- Header -->
                <div class="p-4 border-b border-gray-800 bg-[#0d1117]/90 backdrop-blur">
                    <div class="flex items-center justify-between">
                        <div class="text-sm font-bold text-cyan-400 tracking-widest drop-shadow-[0_0_10px_rgba(6,182,212,0.8)]">TASKS</div>
                        <div class="flex items-center gap-2">
                            <button @click="loadTasks" class="text-xs px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">Refresh</button>
                            <button @click="hideTasksPanel" title="Close"
                                class="text-xs px-2 py-1 rounded bg-[#3b1118] hover:bg-[#6b1f2c] text-white shadow-none hover:shadow-[0_0_14px_rgba(200,80,110,0.85)]">✕</button>
                        </div>
                    </div>
                    <!-- Filters -->
                    <div class="flex items-center gap-2 mt-3">
                        <select v-model="tasksFilterStatus" @change="loadTasks"
                            class="bg-[#0d1117] border border-gray-700 rounded px-2 py-1 text-xs text-white focus:outline-none focus:border-cyan-500">
                            <option value="">All statuses</option>
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="completed">Completed</option>
                            <option value="failed">Failed</option>
                        </select>
                        <select v-model="tasksFilterChannel" @change="loadTasks"
                            class="bg-[#0d1117] border border-gray-700 rounded px-2 py-1 text-xs text-white focus:outline-none focus:border-cyan-500">
                            <option value="">All channels</option>
                            <option value="whatsapp">WhatsApp</option>
                            <option value="web">Web</option>
                            <option value="local">Local</option>
                        </select>
                        <div class="ml-auto text-[10px] text-gray-500">{{ tasksList.length }} tasks</div>
                    </div>
                </div>
                <!-- Task list -->
                <div class="overflow-y-auto" style="max-height: calc(100% - 120px);">
                    <div v-if="tasksList.length === 0" class="p-6 text-center text-xs text-gray-500">No tasks found</div>
                    <div v-for="task in tasksList" :key="task.task_id"
                        class="border-b border-gray-800 p-3 hover:bg-white/5 cursor-pointer"
                        @click="selectedTask = task">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] px-1.5 py-0.5 rounded font-bold"
                                    :class="{
                                        'bg-yellow-900/40 text-yellow-400': task.status === 'pending',
                                        'bg-blue-900/40 text-blue-400': task.status === 'processing',
                                        'bg-green-900/40 text-green-400': task.status === 'completed',
                                        'bg-red-900/40 text-red-400': task.status === 'failed'
                                    }">{{ task.status }}</span>
                                <span class="text-[10px] px-1.5 py-0.5 rounded"
                                    :class="{
                                        'bg-yellow-900/30 text-yellow-300': task.delivery_status === 'pending',
                                        'bg-green-900/30 text-green-300': task.delivery_status === 'sent',
                                        'bg-red-900/30 text-red-300': task.delivery_status === 'failed',
                                        'bg-gray-800 text-gray-400': task.delivery_status === 'skipped'
                                    }">{{ task.delivery_status }}</span>
                            </div>
                            <span class="text-[10px] text-gray-500">{{ task.channel }}</span>
                        </div>
                        <div class="text-xs text-gray-300 mt-1 truncate">{{ task.content_in || '(no input)' }}</div>
                        <div class="flex items-center gap-3 mt-1 text-[10px] text-gray-500">
                            <span>{{ new Date(task.created_at).toLocaleString() }}</span>
                            <span v-if="task.total_tokens">{{ task.total_tokens }} tokens</span>
                            <span class="text-gray-600 truncate" :title="task.task_id">{{ task.task_id.substring(0, 12) }}...</span>
                        </div>
                    </div>
                </div>
                <!-- Selected task detail -->
                <div v-if="selectedTask" class="border-t border-gray-700 p-3 bg-[#0d1117]/80">
                    <div class="text-[10px] uppercase text-gray-500 mb-1">Task Detail</div>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs">
                        <div>Task ID: <span class="text-gray-200">{{ selectedTask.task_id }}</span></div>
                        <div>Trace: <span class="text-gray-200 cursor-pointer hover:text-cyan-400" @click="openTrace({ trace_id: selectedTask.trace_id })">{{ selectedTask.trace_id || '-' }}</span></div>
                        <div>Status: <span class="text-gray-200">{{ selectedTask.status }}</span></div>
                        <div>Delivery: <span class="text-gray-200">{{ selectedTask.delivery_status }} ({{ selectedTask.delivery_attempts }} attempts)</span></div>
                        <div>Tokens: <span class="text-gray-200">{{ selectedTask.prompt_tokens }}p + {{ selectedTask.completion_tokens }}c = {{ selectedTask.total_tokens }}</span></div>
                        <div>Sender: <span class="text-gray-200">{{ selectedTask.sender_id || '-' }}</span></div>
                    </div>
                    <div v-if="selectedTask.content_out" class="mt-2">
                        <div class="text-[10px] text-gray-500">Response:</div>
                        <div class="text-xs text-gray-300 max-h-20 overflow-y-auto whitespace-pre-wrap">{{ selectedTask.content_out }}</div>
                    </div>
                    <div v-if="selectedTask.error_text" class="mt-2">
                        <div class="text-[10px] text-red-500">Error:</div>
                        <div class="text-xs text-red-400">{{ selectedTask.error_text }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timeline Container -->
        <main class="flex-1 overflow-y-auto w-full relative p-4" ref="main">
            <div class="w-full mx-auto grid grid-cols-1 lg:grid-cols-[2fr_5fr] gap-6 relative">
                <!-- Left: Timeline -->
                <div class="relative">
                    <div class="timeline-line"></div>
                    <div class="space-y-6 relative">
                <!-- Web UI Chat Panel -->
                <div class="glass p-4 rounded-xl border border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-sm font-bold text-blue-400 tracking-widest drop-shadow-[0_0_10px_rgba(59,130,246,0.8)]">WEB UI CHAT</div>
                        <div class="text-[10px] text-gray-500">{{ webStatus }}</div>
                        <div v-if="systemCopyStatus" class="text-[10px] text-blue-300 mt-1">{{ systemCopyStatus }}</div>
                    </div>

                    <div class="flex flex-wrap gap-3 items-center mb-3">
                        <label class="text-xs text-gray-500 uppercase">Web User</label>
                        <select v-model="selectedWebUserId" @change="loadWebLink"
                            class="bg-[#0d1117] border border-gray-700 rounded px-2 py-1 text-sm focus:outline-none focus:border-blue-500 text-white">
                            <option value="">Select user</option>
                            <option v-for="u in webUsers" :key="u.id" :value="String(u.id)">{{ u.name }}</option>
                        </select>
                        <button @click="loadWebUsers" class="text-gray-400 hover:text-white text-xs">Refresh</button>
                    </div>

                    <div class="flex flex-wrap gap-2 items-center mb-3">
                        <input v-model="newWebUserName" placeholder="New web user name"
                            class="bg-[#0d1117] border border-gray-700 rounded px-2 py-1 text-sm text-white w-52 focus:outline-none focus:border-blue-500" />
                        <button @click="createWebUser"
                            class="text-xs px-3 py-1 rounded bg-blue-600 hover:bg-blue-500 text-white">Create</button>
                    </div>

                    <div class="flex flex-wrap gap-2 items-center mb-3">
                        <input v-model="linkJid" placeholder="WhatsApp JID (e.g. 123@s.whatsapp.net)"
                            class="bg-[#0d1117] border border-gray-700 rounded px-2 py-1 text-sm text-white w-[22rem] focus:outline-none focus:border-blue-500" />
                        <button @click="saveWebLink"
                            class="text-xs px-3 py-1 rounded bg-green-600 hover:bg-green-500 text-white">Link</button>
                        <button @click="unlinkWebLink"
                            class="text-xs px-3 py-1 rounded bg-yellow-600 hover:bg-yellow-500 text-white">Unlink</button>
                    </div>

                    <div class="flex items-center gap-2 mb-3">
                        <label class="text-xs text-gray-500 uppercase">Override Silent Mode</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" v-model="forceSend" @change="saveForceSend" class="sr-only peer">
                            <div class="w-9 h-5 rounded-full peer transition-colors duration-300"
                                :class="forceSend ? 'bg-purple-600' : 'bg-gray-600'">
                                <div class="absolute top-[2px] left-[2px] w-4 h-4 bg-white rounded-full transition-transform duration-300"
                                    :class="forceSend ? 'translate-x-4' : ''"></div>
                            </div>
                        </label>
                        <span class="text-[10px] text-gray-500">{{ forceSend ? 'FORCE SEND ON' : 'FORCE SEND OFF' }}</span>
                    </div>

                    <div class="flex flex-col gap-2">
                        <div class="relative">
                            <textarea v-model="webChatMessage" rows="2" placeholder="Type message to agent..."
                                class="bg-[#0d1117] border border-gray-700 rounded px-2 py-2 text-sm text-white w-full focus:outline-none focus:border-blue-500 pr-10"></textarea>
                            <button @click="copyWebChat" title="Copy"
                                class="absolute top-2 right-2 text-gray-400 hover:text-white">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 7h11M8 11h11M8 15h11M5 7h.01M5 11h.01M5 15h.01" />
                                </svg>
                            </button>
                        </div>
                        <div class="flex justify-end">
                            <button @click="sendWebChat"
                                class="text-xs px-4 py-2 rounded bg-purple-600 hover:bg-purple-500 text-white">Send</button>
                        </div>
                    </div>
                </div>

                <div v-for="event in filteredEvents" :key="event.id"
                    class="flex items-start gap-4 transition-all duration-300" :class="{'opacity-30': isDimmed(event)}">
                    <!-- Left Side (Bot / System) -->
                    <div class="flex-1 text-right" v-if="isBot(event)">
                        <div class="inline-block text-left max-w-[90%]">
                            <div class="flex items-center justify-end gap-2 mb-1">
                                <span class="text-xs text-gray-500">{{ formatTime(event.timestamp) }}</span>
                                <span class="text-xs font-bold text-blue-400">AGENT</span>
                            </div>
                            <div class="glass p-3 rounded-l-xl rounded-tr-xl border-l-4 border-l-blue-500 relative"
                                :class="[isTechnical(event) ? 'text-xs p-2 opacity-70' : '', event.replay ? 'border border-gray-600' : '']">
                                <div class="flex items-start justify-between gap-2">
                                    <p class="whitespace-pre-wrap flex-1">{{ event.content_text }}</p>
                                    <button @click="copyMessage(event.content_text)" title="Copy to Clipboard Tool"
                                        class="text-gray-400 hover:text-white shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M8 7h11M8 11h11M8 15h11M5 7h.01M5 11h.01M5 15h.01" />
                                        </svg>
                                    </button>
                                    <button @click="copyMessageSystem(event.content_text, 'AGENT')" title="Copy to System Clipboard"
                                        class="text-gray-400 hover:text-white shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M16 1H8c-1.1 0-2 .9-2 2v2H5c-1.1 0-2 .9-2 2v13c0 1.1.9 2 2 2h9c1.1 0 2-.9 2-2v-2h1c1.1 0 2-.9 2-2V7l-3-6ZM14 20H5V7h1v9c0 1.1.9 2 2 2h6v2Zm4-5H8V3h7.17L18 7v8Z"/>
                                        </svg>
                                    </button>
                                    <button @click="openTrace(event)" title="Trace"
                                        :class="event.trace_id ? 'text-gray-400 hover:text-white' : 'text-gray-600 cursor-not-allowed'"
                                        class="shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M3 3h4v4H3V3zm7 7h4v4h-4v-4zm7 7h4v4h-4v-4zM5 7h2v4h4v2H5V7zm7 7h2v4h4v2h-6v-6z"/>
                                        </svg>
                                    </button>
                                </div>
                                <button @click="reprocessMessage(event)" class="group absolute -right-2 top-1/2 -translate-y-1/2 bg-[#161b22] border border-gray-700 rounded-full p-1 text-gray-400 hover:text-white hover:border-blue-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 6V3L8 7l4 4V8c2.76 0 5 2.24 5 5a5 5 0 0 1-5 5 5 5 0 0 1-4.58-3H5.26A7 7 0 0 0 12 20a7 7 0 0 0 0-14z"/>
                                    </svg>
                                    <span class="absolute right-full mr-2 whitespace-nowrap text-[10px] px-2 py-0.5 rounded bg-gray-800 text-gray-200 border border-gray-600 opacity-0 group-hover:opacity-100 transition-opacity">reprocess</span>
                                </button>
                                <div v-if="event.event_type === 'SYSTEM'"
                                    class="mt-2 text-xs text-yellow-500 border-t border-gray-700 pt-1">
                                    LOG: {{ event.classification }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1" v-else></div>

                    <!-- Center Dot -->
                    <div class="w-4 h-4 rounded-full border-2 border-[#0d1117] z-10 shrink-0 mt-8"
                        :class="getDotClass(event)">
                    </div>

                    <!-- Right Side (User) -->
                    <div class="flex-1 text-left" v-if="!isBot(event)">
                        <div class="inline-block max-w-[90%]">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold"
                                    :class="event.authorized ? 'text-green-400' : 'text-yellow-400'">{{ event.sender_id
                                    }}</span>
                                <span v-if="!event.authorized"
                                    class="text-[9px] px-1.5 py-0.5 rounded bg-yellow-900/50 text-yellow-400 border border-yellow-700">⚠
                                    UNAUTHORIZED</span>
                                <span class="text-xs text-gray-500">{{ formatTime(event.timestamp) }}</span>
                            </div>
                            <div class="glass p-3 rounded-r-xl rounded-tl-xl border-r-4 border-r-green-500 relative"
                                :class="[isTechnical(event) ? 'text-xs p-2 opacity-70' : '', event.replay ? 'border border-gray-600' : '']">
                                <!-- Text Content -->
                                <div v-if="event.content_text" class="flex items-start justify-between gap-2">
                                    <p class="whitespace-pre-wrap flex-1">{{ event.content_text }}</p>
                                    <button @click="copyMessage(event.content_text)" title="Copy to Clipboard Tool"
                                        class="text-gray-400 hover:text-white shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M8 7h11M8 11h11M8 15h11M5 7h.01M5 11h.01M5 15h.01" />
                                        </svg>
                                    </button>
                                    <button @click="copyMessageSystem(event.content_text, event.sender_id)" title="Copy to System Clipboard"
                                        class="text-gray-400 hover:text-white shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M16 1H8c-1.1 0-2 .9-2 2v2H5c-1.1 0-2 .9-2 2v13c0 1.1.9 2 2 2h9c1.1 0 2-.9 2-2v-2h1c1.1 0 2-.9 2-2V7l-3-6ZM14 20H5V7h1v9c0 1.1.9 2 2 2h6v2Zm4-5H8V3h7.17L18 7v8Z"/>
                                        </svg>
                                    </button>
                                    <button @click="openTrace(event)" title="Trace"
                                        :class="event.trace_id ? 'text-gray-400 hover:text-white' : 'text-gray-600 cursor-not-allowed'"
                                        class="shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M3 3h4v4H3V3zm7 7h4v4h-4v-4zm7 7h4v4h-4v-4zM5 7h2v4h4v2H5V7zm7 7h2v4h4v2h-6v-6z"/>
                                        </svg>
                                    </button>
                                </div>
                                <button @click="reprocessMessage(event)" class="group absolute -right-2 top-1/2 -translate-y-1/2 bg-[#161b22] border border-gray-700 rounded-full p-1 text-gray-400 hover:text-white hover:border-blue-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 6V3L8 7l4 4V8c2.76 0 5 2.24 5 5a5 5 0 0 1-5 5 5 5 0 0 1-4.58-3H5.26A7 7 0 0 0 12 20a7 7 0 0 0 0-14z"/>
                                    </svg>
                                    <span class="absolute right-full mr-2 whitespace-nowrap text-[10px] px-2 py-0.5 rounded bg-gray-800 text-gray-200 border border-gray-600 opacity-0 group-hover:opacity-100 transition-opacity">reprocess</span>
                                </button>

                                <!-- Image Display -->
                                <div v-if="event.media_path && isImage(event.media_path)" class="mt-2">
                                    <img :src="getMediaUrl(event.media_path)"
                                        class="rounded-lg shadow-md max-w-full max-h-64 object-cover border border-gray-700"
                                        alt="User Image">
                                    <div class="text-[10px] text-gray-500 mt-1 truncate max-w-[200px]">{{
                                        event.media_path.split('/').pop() }}</div>
                                </div>

                                <!-- Audio Player -->
                                <div v-if="event.media_path && isAudio(event.media_path)" class="mt-2">
                                    <audio controls class="w-full h-8" :src="getMediaUrl(event.media_path)"></audio>
                                    <div class="text-[10px] text-gray-500 mt-1 truncate max-w-[200px]">{{
                                        event.media_path.split('/').pop() }}</div>
                                </div>

                                <!-- Document Preview -->
                                <div v-if="event.media_path && isDocument(event.media_path)" class="mt-2">
                                    <a :href="getMediaUrl(event.media_path)" target="_blank"
                                        class="flex items-center gap-3 p-3 rounded-lg bg-[#161b22] border border-gray-700 hover:border-blue-500 transition-colors group cursor-pointer no-underline">
                                        <div class="w-10 h-10 rounded-lg flex items-center justify-center text-lg shrink-0"
                                            :class="docIconClass(event.media_path)">
                                            {{ docIcon(event.media_path) }}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div
                                                class="text-sm font-medium text-gray-200 truncate group-hover:text-blue-400 transition-colors">
                                                {{ event.media_path.split('/').pop() }}
                                            </div>
                                            <div class="text-[10px] text-gray-500 flex items-center gap-2 mt-0.5">
                                                <span>{{ docExt(event.media_path).toUpperCase() }}</span>
                                                <span>•</span>
                                                <span>Click to open</span>
                                            </div>
                                        </div>
                                        <svg xmlns="http://www.w3.org/2000/svg"
                                            class="h-4 w-4 text-gray-500 group-hover:text-blue-400 shrink-0" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                        </svg>
                                    </a>
                                </div>

                                <!-- Classification Tag -->
                                <div v-if="event.classification"
                                    class="mt-2 text-[10px] inline-block px-2 py-0.5 rounded bg-gray-800 text-gray-300 border border-gray-600">
                                    {{ event.classification }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1" v-else></div>
                </div>

                        <div v-if="filteredEvents.length === 0" class="text-center py-20 text-gray-600">
                            NO TIMELINE RECORDS FOUND
                        </div>
                    </div>
                </div>

                <!-- Right Column: Repo Panels (side by side) -->
                <div class="flex flex-row gap-4 items-start">

                <!-- Identity Repo Panel -->
                <github-panel
                    :visible="identityPanelVisible"
                    :floating="identityFloating"
                    :panel="identityPanel"
                    :panel-el="identityPanelEl"
                    :floatable="false"
                    :refreshable="true"
                    :resizable="true"
                    title="IDENTITY REPO"
                    title-class="text-sm font-bold text-purple-300 tracking-widest drop-shadow-[0_0_10px_rgba(192,192,192,0.6)]"
                    icon-class="identity-repo-icon"
                    icon-glow-class="text-white drop-shadow-[0_0_10px_rgba(192,192,192,0.8)]"
                    @refresh="refreshIdentity"
                    @close="hideIdentityPanel">
                    <template #header>
                        <div class="text-[11px] text-gray-400 mb-1">Bot brain + skills + Day2Day live here</div>
                        <div class="text-xs text-gray-500 mb-2 truncate">
                            Path: <span class="text-purple-300 font-semibold text-[11px]">{{ identityRepoPath || 'Not configured' }}</span>
                        </div>
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2 text-[10px] text-gray-400">
                                <span v-if="!idRepoInitialized" class="text-yellow-400">Not initialized</span>
                                <span v-else :class="idRepoHealthClass">{{ idRepoHealthLabel }}</span>
                                <span v-if="idRepoInitialized" class="inline-flex items-center gap-1">
                                    <span class="w-2 h-2 rounded-full" :class="idRepoHealthDot"></span>
                                    <span>{{ idRepoHealthText }}</span>
                                    <span v-if="idRepoHasRemote" class="text-[9px] px-1.5 py-0.5 rounded bg-green-900/40 text-green-400 border border-green-800">REMOTE</span>
                                    <span v-else class="text-[9px] px-1.5 py-0.5 rounded bg-yellow-900/40 text-yellow-400 border border-yellow-800">NO REMOTE</span>
                                </span>
                            </div>
                            <button v-if="!idRepoInitialized" @click="initIdRepo"
                                class="text-[10px] px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">Init Repo</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-gray-400">Branch</span>
                            <select v-model="idSelectedBranch"
                                class="bg-[#0d1117] border border-gray-700 rounded px-2 py-1 text-xs text-white w-full focus:outline-none focus:border-purple-500">
                                <option value="">Select branch</option>
                                <option v-for="b in idRepoBranches" :key="b" :value="b">{{ b }}</option>
                            </select>
                            <button @click="checkoutIdBranch"
                                class="text-[10px] px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">Checkout</button>
                        </div>
                    </template>

                    <div class="flex items-center gap-2 mb-3 text-[10px] uppercase text-gray-400">
                        <button @click="idRepoTab = 'files'" :class="idRepoTab === 'files' ? 'text-white' : ''" class="px-2 py-1 rounded hover:bg-[#161b22]">Files</button>
                        <button @click="idRepoTab = 'diff'" :class="idRepoTab === 'diff' ? 'text-white' : ''" class="px-2 py-1 rounded hover:bg-[#161b22]">Diff</button>
                        <button @click="idRepoTab = 'status'" :class="idRepoTab === 'status' ? 'text-white' : ''" class="px-2 py-1 rounded hover:bg-[#161b22]">Status</button>
                        <button @click="idRepoTab = 'history'" :class="idRepoTab === 'history' ? 'text-white' : ''" class="px-2 py-1 rounded hover:bg-[#161b22]">History</button>
                    </div>
                    <div v-if="idRepoActionStatus" class="mb-3 text-[11px] flex items-center gap-2 px-2 py-1 rounded border"
                        :class="idRepoActionOk === true ? 'border-green-700 bg-green-900/20 text-green-300' : (idRepoActionOk === false ? 'border-red-700 bg-red-900/20 text-red-300' : 'border-gray-700 bg-gray-900/20 text-gray-300')">
                        <span class="uppercase tracking-wide text-[10px]">Last action</span>
                        <span class="font-semibold">{{ idRepoActionStatus }}</span>
                        <span v-if="idRepoActionAt" class="text-gray-400">{{ idRepoActionAt }}</span>
                    </div>

                    <div v-if="idRepoTab === 'files'">
                        <div class="mb-3">
                            <div class="text-[10px] uppercase text-gray-500 mb-1">Files</div>
                            <div class="max-h-64 overflow-y-auto border border-gray-800 rounded">
                                <div v-for="item in idRepoTree" :key="item.path"
                                    class="px-2 py-1 text-xs flex items-center gap-2 hover:bg-[#161b22] cursor-pointer"
                                    @click="selectIdRepoItem(item)">
                                    <span :style="{ marginLeft: (item.depth * 10) + 'px' }">{{ item.type === 'dir' ? '📁' : '📄' }}</span>
                                    <span :class="isIdItemChanged(item) ? 'text-yellow-500 font-semibold' : 'text-gray-200'">{{ item.name }}</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="text-[10px] uppercase text-gray-500 mb-1">Preview</div>
                            <pre class="text-xs bg-[#0d1117] border border-gray-700 rounded p-2 overflow-auto resize-y"
                                style="resize: vertical; min-height: 160px; max-height: 480px;">{{ idRepoFileContent }}</pre>
                        </div>
                    </div>

                    <div v-if="idRepoTab === 'diff'">
                        <div class="text-[10px] uppercase text-gray-500 mb-1">Diff</div>
                        <pre class="text-xs bg-[#0d1117] border border-gray-700 rounded p-2 overflow-auto resize-y"
                            style="resize: vertical; min-height: 200px; max-height: 560px;">{{ idRepoFileDiff || idRepoDiff }}</pre>
                    </div>

                    <div v-if="idRepoTab === 'status'">
                        <div class="mb-3">
                            <div class="text-[10px] uppercase text-gray-500 mb-1">Git Status</div>
                            <pre class="text-xs bg-[#0d1117] border border-gray-700 rounded p-2 max-h-24 overflow-auto">{{ idRepoStatus }}</pre>
                        </div>
                        <div class="mb-3">
                            <div class="text-[10px] uppercase text-gray-500 mb-1">Commit</div>
                            <input v-model="idRepoCommitMessage" placeholder="Commit message"
                                class="bg-[#0d1117] border border-gray-700 rounded px-2 py-1 text-xs text-white w-full focus:outline-none focus:border-purple-500 mb-2" />
                            <button @click="commitIdRepo"
                                class="text-[10px] px-2 py-1 rounded bg-purple-700 hover:bg-purple-600 text-white">Commit</button>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <input v-model="idRepoRemoteUrl" placeholder="Remote URL (optional)"
                                class="bg-[#0d1117] border border-gray-700 rounded px-2 py-1 text-xs text-white w-full focus:outline-none focus:border-purple-500" />
                            <button v-if="!idRepoInitialized" @click="initIdRepo"
                                class="text-[10px] px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">Init Repo</button>
                            <button @click="pullIdRepo"
                                class="text-[10px] px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">Pull</button>
                            <button @click="pushIdRepo"
                                class="text-[10px] px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">Push</button>
                        </div>
                    </div>

                    <div v-if="idRepoTab === 'history'">
                        <div class="text-[10px] uppercase text-gray-500 mb-1">Commit History</div>
                        <div class="max-h-64 overflow-y-auto border border-gray-800 rounded">
                            <div v-for="c in idRepoCommits" :key="c" class="px-2 py-1 text-xs border-b border-gray-800">{{ c }}</div>
                        </div>
                    </div>

                    <div class="p-3 border-t border-gray-800 sticky bottom-0 bg-[#0d1117]/80 backdrop-blur flex items-center justify-between mt-3">
                        <span class="text-[10px] text-gray-500">Actions</span>
                        <div class="flex gap-2">
                            <button @click="commitIdRepo"
                                class="text-[10px] px-2 py-1 rounded bg-purple-700 hover:bg-purple-600 text-white">Commit</button>
                            <button @click="pushIdRepo"
                                class="text-[10px] px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">Push</button>
                        </div>
                    </div>
                </github-panel>

                <!-- Work Repo Panel -->
                <github-panel
                    :visible="repoPanelVisible"
                    :floating="repoFloating"
                    :panel="repoPanel"
                    :panel-el="repoPanelEl"
                    :floatable="true"
                    :refreshable="true"
                    :resizable="true"
                    title="WORK REPO"
                    title-class="text-sm font-bold text-green-400 tracking-widest drop-shadow-[0_0_10px_rgba(34,197,94,0.8)]"
                    icon-class="work-repo-icon"
                    icon-glow-class="text-white drop-shadow-[0_0_8px_rgba(34,197,94,0.85)]"
                    @toggle-float="toggleRepoFloating"
                    @refresh="refreshRepo"
                    @close="hideRepoPanel"
                    @drag="startDragRepo"
                    @resize="startResizeRepo">
                    <template #header>
                        <div class="text-xs text-gray-500 mb-2 truncate relative">
                            Repo: <span class="underline decoration-dotted cursor-help font-semibold text-sm bg-gradient-to-r from-fuchsia-400 via-pink-400 to-purple-400 bg-clip-text text-transparent drop-shadow-[0_0_10px_rgba(217,70,239,0.7)]"
                                @mouseenter="showRepoTooltip" @mouseleave="hideRepoTooltip">{{ workRepoPath }}</span>
                            <div v-if="repoHover" class="fixed z-50">
                                <div class="glass border border-gray-700 rounded p-3 text-[10px] shadow-xl"
                                    style="width: min(520px, 90vw); max-height: 60vh;"
                                    :style="repoHoverStyle">
                                    <div class="text-gray-400 mb-1">Repo Config</div>
                                    <div class="text-gray-200 break-all">{{ workRepoPath }}</div>
                                    <div class="text-gray-400 mt-2 mb-1">Remotes</div>
                                    <pre class="text-gray-200 whitespace-pre-wrap break-all max-h-48 overflow-auto">{{ repoRemoteInfo || 'No remote configured' }}</pre>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2 text-[10px] text-gray-400">
                                <span v-if="!repoInitialized" class="text-yellow-400">Not initialized</span>
                                <span v-else :class="repoHealthClass">{{ repoHealthLabel }}</span>
                                <span v-if="repoInitialized" class="inline-flex items-center gap-1">
                                    <span class="w-2 h-2 rounded-full" :class="repoHealthDot"></span>
                                    <span>{{ repoHealthText }}</span>
                                    <span v-if="repoHasRemote" class="text-[9px] px-1.5 py-0.5 rounded bg-green-900/40 text-green-400 border border-green-800">REMOTE</span>
                                    <span v-else class="text-[9px] px-1.5 py-0.5 rounded bg-yellow-900/40 text-yellow-400 border border-yellow-800">NO REMOTE</span>
                                    <button v-if="!repoInitialized" @click="initRepo"
                                        class="text-[9px] px-2 py-0.5 rounded bg-gray-700 hover:bg-gray-600 text-white">Init Repo</button>
                                </span>
                            </div>
                            <button v-if="!repoInitialized" @click="initRepo"
                                class="text-[10px] px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">Init Repo</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-gray-400">Branch</span>
                            <select v-model="selectedBranch"
                                class="bg-[#0d1117] border border-gray-700 rounded px-2 py-1 text-xs text-white w-full focus:outline-none focus:border-blue-500">
                                <option value="">Select branch</option>
                                <option v-for="b in repoBranches" :key="b" :value="b">{{ b }}</option>
                            </select>
                            <button @click="checkoutBranch"
                                class="text-[10px] px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">Checkout</button>
                        </div>
                    </template>

                    <div class="flex items-center gap-2 mb-3 text-[10px] uppercase text-gray-400">
                        <button @click="repoTab = 'files'" :class="repoTab === 'files' ? 'text-white' : ''" class="px-2 py-1 rounded hover:bg-[#161b22]">Files</button>
                        <button @click="repoTab = 'diff'" :class="repoTab === 'diff' ? 'text-white' : ''" class="px-2 py-1 rounded hover:bg-[#161b22]">Diff</button>
                        <button @click="repoTab = 'pr'" :class="repoTab === 'pr' ? 'text-white' : ''" class="px-2 py-1 rounded hover:bg-[#161b22]">PR</button>
                        <button @click="repoTab = 'status'" :class="repoTab === 'status' ? 'text-white' : ''" class="px-2 py-1 rounded hover:bg-[#161b22]">Status</button>
                        <button @click="repoTab = 'history'" :class="repoTab === 'history' ? 'text-white' : ''" class="px-2 py-1 rounded hover:bg-[#161b22]">History</button>
                    </div>
                    <div v-if="repoActionStatus" class="mb-3 text-[11px] flex items-center gap-2 px-2 py-1 rounded border"
                        :class="repoActionOk === true ? 'border-green-700 bg-green-900/20 text-green-300' : (repoActionOk === false ? 'border-red-700 bg-red-900/20 text-red-300' : 'border-gray-700 bg-gray-900/20 text-gray-300')">
                        <span class="uppercase tracking-wide text-[10px]">Last action</span>
                        <span class="font-semibold">{{ repoActionStatus }}</span>
                        <span v-if="repoActionAt" class="text-gray-400">{{ repoActionAt }}</span>
                    </div>

                    <div v-if="repoTab === 'files'">
                        <div class="mb-3">
                            <div class="text-[10px] uppercase text-gray-500 mb-1">Files</div>
                            <div class="max-h-64 overflow-y-auto border border-gray-800 rounded">
                                <div v-for="item in repoTree" :key="item.path"
                                    class="px-2 py-1 text-xs flex items-center gap-2 hover:bg-[#161b22] cursor-pointer"
                                    @click="selectRepoItem(item)">
                                    <span :style="{ marginLeft: (item.depth * 10) + 'px' }">{{ item.type === 'dir' ? '📁' : '📄' }}</span>
                                    <span :class="isItemChanged(item) ? 'text-yellow-500 font-semibold' : 'text-gray-200'">{{ item.name }}</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="text-[10px] uppercase text-gray-500 mb-1">Preview</div>
                            <pre class="text-xs bg-[#0d1117] border border-gray-700 rounded p-2 overflow-auto resize-y"
                                style="resize: vertical; min-height: 160px; max-height: 480px;">{{ repoFileContent }}</pre>
                        </div>
                    </div>

                    <div v-if="repoTab === 'diff'">
                        <div class="text-[10px] uppercase text-gray-500 mb-1">Diff</div>
                        <pre class="text-xs bg-[#0d1117] border border-gray-700 rounded p-2 overflow-auto resize-y"
                            style="resize: vertical; min-height: 200px; max-height: 560px;">{{ repoFileDiff || repoDiff }}</pre>
                    </div>

                    <div v-if="repoTab === 'pr'">
                        <div class="mb-3">
                            <div class="text-[10px] uppercase text-gray-500 mb-1">Create PR</div>
                            <input v-model="prTitle" placeholder="PR title"
                                class="bg-[#0d1117] border border-gray-700 rounded px-2 py-1 text-xs text-white w-full focus:outline-none focus:border-blue-500 mb-1" />
                            <textarea v-model="prBody" rows="2" placeholder="PR body"
                                class="bg-[#0d1117] border border-gray-700 rounded px-2 py-1 text-xs text-white w-full focus:outline-none focus:border-blue-500 mb-1"></textarea>
                            <div class="flex gap-2">
                                <input v-model="prBase" placeholder="base (optional)"
                                    class="bg-[#0d1117] border border-gray-700 rounded px-2 py-1 text-xs text-white w-full focus:outline-none focus:border-blue-500" />
                                <input v-model="prHead" placeholder="head (optional)"
                                    class="bg-[#0d1117] border border-gray-700 rounded px-2 py-1 text-xs text-white w-full focus:outline-none focus:border-blue-500" />
                                </div>
                                <div class="flex items-center gap-2 mt-2">
                                    <input type="checkbox" v-model="prDraft" class="accent-blue-500">
                                    <span class="text-[10px] text-gray-400">Draft</span>
                                    <button @click="createPr"
                                        class="text-[10px] px-2 py-1 rounded bg-green-700 hover:bg-green-600 text-white">Create PR</button>
                                </div>
                            </div>
                            <div class="text-[10px] uppercase text-gray-500 mb-1">GitHub Auth</div>
                            <pre class="text-xs bg-[#0d1117] border border-gray-700 rounded p-2 max-h-20 overflow-auto">{{ ghAuthStatus }}</pre>
                        </div>

                        <!-- Status Tab -->
                        <div v-if="repoTab === 'status'">
                            <div class="mb-3">
                                <div class="text-[10px] uppercase text-gray-500 mb-1">Git Status</div>
                                <pre class="text-xs bg-[#0d1117] border border-gray-700 rounded p-2 max-h-24 overflow-auto">{{ repoStatus }}</pre>
                            </div>
                            <div class="mb-3">
                                <div class="text-[10px] uppercase text-gray-500 mb-1">Commit</div>
                                <input v-model="repoCommitMessage" placeholder="Commit message"
                                    class="bg-[#0d1117] border border-gray-700 rounded px-2 py-1 text-xs text-white w-full focus:outline-none focus:border-blue-500 mb-2" />
                                <button @click="commitRepo"
                                    class="text-[10px] px-2 py-1 rounded bg-blue-700 hover:bg-blue-600 text-white">Commit</button>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <input v-model="repoRemoteUrl" placeholder="Remote URL (optional)"
                                    class="bg-[#0d1117] border border-gray-700 rounded px-2 py-1 text-xs text-white w-full focus:outline-none focus:border-blue-500" />
                                <button v-if="!repoInitialized" @click="initRepo"
                                    class="text-[10px] px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">Init Repo</button>
                                <button @click="pullRepo"
                                    class="text-[10px] px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">Pull</button>
                                <button @click="pushRepo"
                                    class="text-[10px] px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">Push</button>
                            </div>
                        </div>

                        <!-- History Tab -->
                        <div v-if="repoTab === 'history'">
                            <div class="text-[10px] uppercase text-gray-500 mb-1">Commit History</div>
                            <div class="max-h-64 overflow-y-auto border border-gray-800 rounded">
                                <div v-for="c in repoCommits" :key="c" class="px-2 py-1 text-xs border-b border-gray-800">{{ c }}</div>
                            </div>
                        </div>

                    <div class="p-3 border-t border-gray-800 sticky bottom-0 bg-[#0d1117]/80 backdrop-blur flex items-center justify-between">
                        <span class="text-[10px] text-gray-500">Actions</span>
                        <div class="flex gap-2">
                            <button @click="commitRepo"
                                class="text-[10px] px-2 py-1 rounded bg-blue-700 hover:bg-blue-600 text-white">Commit</button>
                            <button @click="pushRepo"
                                class="text-[10px] px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">Push</button>
                            <button @click="createPr"
                                class="text-[10px] px-2 py-1 rounded bg-green-700 hover:bg-green-600 text-white">PR</button>
                        </div>
                    </div>

                </github-panel>

                </div><!-- /Right Column wrapper -->
            </div>

            <!-- Trace Viewer — centered modal overlay, same v-if pattern as repo panel -->
            <div v-if="tracePanelVisible" ref="tracePanelEl"
                class="fixed inset-0 z-50 flex items-center justify-center"
                @click.self="hideTracePanel">
                <div class="glass rounded-xl border border-gray-700 overflow-hidden shadow-2xl"
                    :class="traceFloating ? 'fixed z-50 resize' : ''"
                    :style="traceFloating
                        ? { left: tracePanel.x + 'px', top: tracePanel.y + 'px', width: tracePanel.w + 'px', height: tracePanel.h + 'px' }
                        : { width: '460px', maxWidth: '92vw', height: '600px', maxHeight: '80vh' }">
                    <!-- Header -->
                    <div class="p-4 border-b border-gray-800 bg-[#0d1117]/90 backdrop-blur"
                        :class="traceFloating ? 'cursor-move select-none' : ''" @mousedown="startDragTrace">
                        <div class="flex items-center justify-between">
                <div class="text-sm font-bold text-purple-400 tracking-widest drop-shadow-[0_0_10px_rgba(168,85,247,0.8)]">TRACE VIEWER</div>
                            <div class="flex items-center gap-2">
                                <button @click.stop="traceViewMode = traceViewMode === 'list' ? 'graph' : 'list'; if(traceViewMode === 'graph') nextTick(renderTraceGraph)"
                                    class="text-xs px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">
                                    {{ traceViewMode === 'list' ? 'Graph' : 'List' }}
                                </button>
                                <button @click.stop="toggleTraceFloating"
                                    class="text-xs px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">
                                    {{ traceFloating ? 'Dock' : 'Float' }}
                                </button>
                                <button @click.stop="copyTraceJson"
                                    class="text-xs px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white transition-colors"
                                    :class="{ 'bg-green-700 hover:bg-green-600': traceJsonCopied }">
                                    {{ traceJsonCopied ? 'Copied!' : 'Copy JSON' }}
                                </button>
                                <button @click.stop="hideTracePanel" title="Close"
                                    class="text-xs px-2 py-1 rounded bg-[#3b1118] hover:bg-[#6b1f2c] text-white shadow-none hover:shadow-[0_0_14px_rgba(200,80,110,0.85)]">✕</button>
                            </div>
                        </div>
                        <div class="text-xs text-gray-400 mt-2">
                            trace: <span class="text-gray-200">{{ traceMeta.traceId || 'no trace id' }}</span><br>
                            channel: <span class="text-gray-200">{{ traceMeta.channel }}</span>
                        </div>
                    </div>
                    <!-- Spans pipeline / Graph toggle -->
                    <div v-if="traceViewMode === 'list'" class="p-4 space-y-3 overflow-y-auto" style="max-height: calc(100% - 120px);">
                        <!-- Horizontal span pipeline (matches group.html) -->
                        <div v-if="traceSpans.length > 0" class="flex flex-wrap gap-1 items-center py-1">
                            <template v-for="(span, si) in traceSpans" :key="span.id">
                                <div class="flex items-center gap-1 px-2 py-1 rounded text-[10px] font-semibold cursor-pointer transition-all"
                                    :style="{ background: spanTypeColorHex(span.type) + (selectedSpan && selectedSpan.id === span.id ? '40' : '20'), color: spanTypeColorHex(span.type), border: '2px solid ' + spanTypeColorHex(span.type) + (selectedSpan && selectedSpan.id === span.id ? 'cc' : '40') }"
                                    @click="selectedSpan = (selectedSpan && selectedSpan.id === span.id) ? null : span">
                                    {{ span.type }}
                                    <span class="text-[9px] opacity-60">{{ span.time }}</span>
                                    <span v-if="span.duration" class="text-[9px] opacity-40">{{ span.duration }}</span>
                                </div>
                                <svg v-if="si < traceSpans.length - 1" class="h-3 w-3 text-gray-600 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                                </svg>
                            </template>
                        </div>
                        <div v-else class="text-[10px] text-gray-600 italic">No spans recorded for this trace</div>

                        <!-- Rich span detail panel -->
                        <div v-if="selectedSpan" class="bg-[#0d1117] rounded p-3 text-[10px] text-gray-400 space-y-2 border border-gray-800">
                            <!-- LLM detail -->
                            <template v-if="selectedSpan.type === 'LLM' && selectedSpan.metadata">
                                <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-gray-500">
                                    <span>Model: <span class="text-purple-400">{{ selectedSpan.metadata.model }}</span></span>
                                    <span>Temp: <span class="text-gray-400">{{ selectedSpan.metadata.temperature }}</span></span>
                                    <span>Max Tokens: <span class="text-gray-400">{{ selectedSpan.metadata.max_tokens }}</span></span>
                                    <span>Duration: <span class="text-gray-400">{{ selectedSpan.metadata.duration_ms }}ms</span></span>
                                    <span>Prompt Tokens: <span class="text-blue-400">{{ selectedSpan.metadata.prompt_tokens }}</span></span>
                                    <span>Completion Tokens: <span class="text-green-400">{{ selectedSpan.metadata.completion_tokens }}</span></span>
                                    <span>Total Tokens: <span class="text-yellow-400">{{ selectedSpan.metadata.total_tokens }}</span></span>
                                    <span>Finish: <span class="text-gray-400">{{ selectedSpan.metadata.finish_reason }}</span></span>
                                </div>
                                <div v-if="selectedSpan.metadata.system_prompt" class="space-y-1">
                                    <div class="text-[9px] text-gray-600 uppercase font-semibold">System Prompt</div>
                                    <pre class="whitespace-pre-wrap max-h-32 overflow-y-auto bg-[#161b22] rounded p-2 text-gray-500 text-[10px]">{{ selectedSpan.metadata.system_prompt }}</pre>
                                </div>
                                <div v-if="selectedSpan.metadata.last_user_message" class="space-y-1">
                                    <div class="text-[9px] text-gray-600 uppercase font-semibold">Last User Message</div>
                                    <pre class="whitespace-pre-wrap max-h-32 overflow-y-auto bg-[#161b22] rounded p-2 text-blue-400/80 text-[10px]">{{ selectedSpan.metadata.last_user_message }}</pre>
                                </div>
                                <div v-if="selectedSpan.metadata.response_text" class="space-y-1">
                                    <div class="text-[9px] text-gray-600 uppercase font-semibold">LLM Response</div>
                                    <pre class="whitespace-pre-wrap max-h-32 overflow-y-auto bg-[#161b22] rounded p-2 text-green-400/80 text-[10px]">{{ selectedSpan.metadata.response_text }}</pre>
                                </div>
                                <div v-if="selectedSpan.metadata.tool_calls && selectedSpan.metadata.tool_calls.length > 0" class="space-y-1">
                                    <div class="text-[9px] text-gray-600 uppercase font-semibold">Tool Calls Requested</div>
                                    <div v-for="(tc, tci) in selectedSpan.metadata.tool_calls" :key="tci" class="bg-[#161b22] rounded p-2 space-y-1">
                                        <span class="text-orange-400 font-semibold">{{ tc.name }}</span>
                                        <pre class="whitespace-pre-wrap max-h-24 overflow-y-auto text-gray-500 text-[10px]">{{ JSON.stringify(tc.arguments, null, 2) }}</pre>
                                    </div>
                                </div>
                            </template>
                            <!-- TOOL detail -->
                            <template v-else-if="selectedSpan.type === 'TOOL' && selectedSpan.metadata">
                                <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-gray-500">
                                    <span>Tool: <span class="text-orange-400 font-semibold">{{ selectedSpan.metadata.tool_name }}</span></span>
                                    <span>Duration: <span class="text-gray-400">{{ selectedSpan.metadata.duration_ms }}ms</span></span>
                                </div>
                                <div v-if="selectedSpan.metadata.arguments" class="space-y-1">
                                    <div class="text-[9px] text-gray-600 uppercase font-semibold">Arguments</div>
                                    <pre class="whitespace-pre-wrap max-h-32 overflow-y-auto bg-[#161b22] rounded p-2 text-blue-400/80 text-[10px]">{{ JSON.stringify(selectedSpan.metadata.arguments, null, 2) }}</pre>
                                </div>
                                <div v-if="selectedSpan.metadata.result" class="space-y-1">
                                    <div class="text-[9px] text-gray-600 uppercase font-semibold">Result</div>
                                    <pre class="whitespace-pre-wrap max-h-32 overflow-y-auto bg-[#161b22] rounded p-2 text-green-400/80 text-[10px]">{{ selectedSpan.metadata.result }}</pre>
                                </div>
                                <div v-if="selectedSpan.metadata.error" class="space-y-1">
                                    <div class="text-[9px] text-gray-600 uppercase font-semibold">Error</div>
                                    <pre class="whitespace-pre-wrap bg-[#161b22] rounded p-2 text-red-400 text-[10px]">{{ selectedSpan.metadata.error }}</pre>
                                </div>
                            </template>
                            <!-- INBOUND detail -->
                            <template v-else-if="selectedSpan.type === 'INBOUND' && selectedSpan.metadata">
                                <div class="grid grid-cols-3 gap-x-4 gap-y-1 text-gray-500">
                                    <span>Channel: <span class="text-blue-400">{{ selectedSpan.metadata.channel }}</span></span>
                                    <span>Sender: <span class="text-gray-400">{{ selectedSpan.metadata.sender }}</span></span>
                                    <span>Type: <span class="text-gray-400">{{ selectedSpan.metadata.message_type }}</span></span>
                                </div>
                                <div v-if="selectedSpan.metadata.content" class="space-y-1">
                                    <div class="text-[9px] text-gray-600 uppercase font-semibold">Message Content</div>
                                    <pre class="whitespace-pre-wrap max-h-32 overflow-y-auto bg-[#161b22] rounded p-2 text-blue-400/80 text-[10px]">{{ selectedSpan.metadata.content }}</pre>
                                </div>
                            </template>
                            <!-- OUTBOUND detail -->
                            <template v-else-if="selectedSpan.type === 'OUTBOUND'">
                                <div v-if="selectedSpan.metadata" class="grid grid-cols-2 gap-x-4 gap-y-1 text-gray-500">
                                    <span>Delivery: <span class="text-green-400">{{ selectedSpan.metadata.delivery_status }}</span></span>
                                </div>
                                <div v-if="selectedSpan.metadata && selectedSpan.metadata.response_text" class="space-y-1">
                                    <div class="text-[9px] text-gray-600 uppercase font-semibold">Response Text</div>
                                    <pre class="whitespace-pre-wrap max-h-32 overflow-y-auto bg-[#161b22] rounded p-2 text-green-400/80 text-[10px]">{{ selectedSpan.metadata.response_text }}</pre>
                                </div>
                            </template>
                            <!-- Fallback -->
                            <div v-else class="text-gray-600 italic">No detailed metadata available for this span</div>
                        </div>

                        <!-- Task metadata grid -->
                        <div v-if="traceTaskInfo" class="bg-[#0d1117] rounded p-2 text-[10px] text-gray-500 grid grid-cols-3 gap-x-4 gap-y-1">
                            <span>Task: <span class="text-gray-400">{{ traceTaskInfo.task_id }}</span></span>
                            <span>Status: <span class="font-bold"
                                :class="{
                                    'text-yellow-400': traceTaskInfo.status === 'pending',
                                    'text-blue-400': traceTaskInfo.status === 'processing',
                                    'text-green-400': traceTaskInfo.status === 'completed',
                                    'text-red-400': traceTaskInfo.status === 'failed'
                                }">{{ traceTaskInfo.status }}</span></span>
                            <span>Delivery: <span class="text-gray-400">{{ traceTaskInfo.delivery_status }}</span></span>
                            <span>Prompt: <span class="text-gray-400">{{ traceTaskInfo.prompt_tokens }}</span></span>
                            <span>Completion: <span class="text-gray-400">{{ traceTaskInfo.completion_tokens }}</span></span>
                            <span>Total: <span class="text-gray-400">{{ traceTaskInfo.total_tokens }}</span></span>
                        </div>

                        <!-- Policy decision pills -->
                        <div v-if="tracePolicyDecisions && tracePolicyDecisions.length > 0" class="flex flex-wrap gap-1">
                            <div v-for="(pd, pi) in tracePolicyDecisions" :key="pi"
                                class="text-[9px] px-2 py-0.5 rounded"
                                :class="pd.allowed ? 'bg-green-900/20 text-green-400 border border-green-800/30' : 'bg-red-900/20 text-red-400 border border-red-800/30'">
                                {{ pd.tool }} T{{ pd.tier }} {{ pd.allowed ? 'ALLOW' : 'DENY' }}
                                <span v-if="pd.reason" class="opacity-60">({{ pd.reason }})</span>
                            </div>
                        </div>
                    </div>
                    <!-- Trace Graph View -->
                    <div v-if="traceViewMode === 'graph'" class="trace-graph-container" style="height: calc(100% - 120px);">
                        <svg ref="traceGraphSvg"></svg>
                    </div>
                    <!-- Resize handle -->
                    <div v-if="traceFloating"
                        class="absolute bottom-2 right-2 w-4 h-4 cursor-se-resize opacity-70 hover:opacity-100"
                        @mousedown.stop="startResizeTrace">
                        <div class="w-4 h-4 border-r-2 border-b-2 border-dashed border-gray-500"></div>
                    </div>
                </div>
            </div>

            <!-- Group Panel -->
            <div v-if="appMode !== 'standalone' && groupPanelVisible" class="fixed inset-0 z-50 flex items-center justify-center" @click.self="groupPanelVisible = false">
                <div class="glass rounded-xl border border-gray-700 overflow-hidden shadow-2xl" style="width: 500px; max-width: 92vw; height: 500px; max-height: 80vh;">
                    <div class="p-4 border-b border-gray-800 bg-[#0d1117]/90 backdrop-blur">
                        <div class="flex items-center justify-between">
                            <div class="text-sm font-bold text-amber-400 tracking-widest">GROUP</div>
                            <button @click.stop="groupPanelVisible = false" class="text-xs px-2 py-1 rounded bg-[#3b1118] hover:bg-[#6b1f2c] text-white">&#x2715;</button>
                        </div>
                        <div class="text-xs text-gray-400 mt-2">
                            Name: <span class="text-gray-200">{{ groupStatus.group_name }}</span> &bull;
                            Members: <span class="text-gray-200">{{ groupStatus.member_count }}</span> &bull;
                            LFS: <span :class="groupStatus.lfs_healthy ? 'text-green-400' : 'text-red-400'">{{ groupStatus.lfs_healthy ? 'healthy' : 'down' }}</span>
                        </div>
                    </div>
                    <div class="p-4 space-y-2 overflow-y-auto" style="max-height: calc(100% - 100px);">
                        <div v-for="member in groupMembers" :key="member.agent_id"
                            class="border border-gray-700 rounded p-3 hover:border-amber-500">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-bold text-gray-200">{{ member.agent_name || member.agent_id }}</span>
                                <span class="text-[10px] px-1.5 py-0.5 rounded" :class="member.status === 'active' ? 'bg-green-900/40 text-green-400' : 'bg-yellow-900/40 text-yellow-400'">{{ member.status }}</span>
                            </div>
                            <div class="text-[10px] text-gray-500">{{ member.agent_id }}</div>
                            <div v-if="member.soul_summary" class="text-xs text-gray-400 mt-1">{{ member.soul_summary }}</div>
                            <div class="text-[10px] text-gray-500 mt-1">
                                Model: <span class="text-gray-300">{{ member.model || '-' }}</span> &bull;
                                Capabilities: <span class="text-gray-300">{{ (JSON.parse(member.capabilities || '[]')).join(', ') || '-' }}</span>
                            </div>
                        </div>
                        <div v-if="!groupMembers.length" class="text-xs text-gray-500 text-center py-8">No members</div>
                        <div class="mt-4 pt-3 border-t border-gray-800 text-center">
                            <a href="/group" class="inline-flex items-center gap-2 text-xs text-amber-400 hover:text-amber-300 transition-colors">
                                Open Group Management
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Memory Manager Panel -->
            <div v-if="memoryPanelVisible" class="fixed inset-0 z-50 flex items-center justify-center"
                @click.self="hideMemoryPanel">
                <div class="glass rounded-xl border border-gray-700 overflow-hidden shadow-2xl"
                    style="width: 720px; max-width: 95vw; height: 700px; max-height: 90vh;">
                    <!-- Header -->
                    <div class="p-4 border-b border-gray-800 bg-[#0d1117]/90 backdrop-blur">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="text-sm font-bold tracking-widest" style="color: #a855f7; text-shadow: 0 0 10px rgba(168,85,247,0.8);">MEMORY MANAGER</div>
                                <span class="text-[10px] px-2 py-0.5 rounded-full bg-purple-900/30 text-purple-300">{{ memoryTotalChunks.toLocaleString() }} / {{ memoryMaxChunks.toLocaleString() }} chunks</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button @click="memoryPruneNow" class="text-[10px] px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">Prune Now</button>
                                <button @click="loadMemoryStatus" class="text-[10px] px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">Refresh</button>
                                <button @click="hideMemoryPanel" title="Close"
                                    class="text-xs px-2 py-1 rounded bg-[#3b1118] hover:bg-[#6b1f2c] text-white shadow-none hover:shadow-[0_0_14px_rgba(200,80,110,0.85)]">&#x2715;</button>
                            </div>
                        </div>
                        <!-- Capacity gauge -->
                        <div class="mt-3">
                            <div class="mem-gauge-bar">
                                <div class="mem-gauge-fill" :style="{ width: memoryUsagePercent + '%', background: memoryUsagePercent > 90 ? '#f85149' : memoryUsagePercent > 70 ? '#fbbf24' : '#a855f7' }"></div>
                            </div>
                            <div class="flex justify-between text-[9px] text-gray-500 mt-1">
                                <span>0</span>
                                <span>{{ memoryUsagePercent }}% used</span>
                                <span>{{ memoryMaxChunks.toLocaleString() }}</span>
                            </div>
                        </div>
                        <div v-if="memoryActionStatus" class="text-[10px] mt-2" :class="memoryActionOk ? 'text-green-400' : 'text-red-400'">{{ memoryActionStatus }}</div>
                    </div>
                    <!-- Body -->
                    <div class="overflow-y-auto p-4 space-y-4" style="max-height: calc(100% - 140px);">
                        <!-- Memory Layers -->
                        <div class="text-[10px] uppercase text-gray-500 tracking-wider mb-1">Memory Layers</div>
                        <div class="grid grid-cols-2 gap-3">
                            <div v-for="layer in memoryLayers" :key="layer.name"
                                class="border border-gray-700 rounded-lg p-3 hover:border-purple-500/50 transition-colors">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-2">
                                        <div class="w-2.5 h-2.5 rounded-full" :style="{ background: layer.color }"></div>
                                        <span class="text-xs font-bold text-gray-200 uppercase">{{ layer.name }}</span>
                                    </div>
                                    <span class="text-[10px] px-1.5 py-0.5 rounded bg-gray-800 text-gray-400">{{ layer.ttl_days > 0 ? layer.ttl_days + 'd TTL' : 'permanent' }}</span>
                                </div>
                                <div class="text-[10px] text-gray-500 mb-2">{{ layer.description }}</div>
                                <div class="flex items-center justify-between">
                                    <div class="flex-1 mr-3">
                                        <div class="mem-gauge-bar">
                                            <div class="mem-gauge-fill" :style="{ width: (memoryMaxChunks > 0 ? (layer.chunk_count / memoryMaxChunks * 100) : 0) + '%', background: layer.color }"></div>
                                        </div>
                                        <div class="text-[9px] text-gray-500 mt-0.5">{{ layer.chunk_count.toLocaleString() }} chunks</div>
                                    </div>
                                    <button @click="memoryResetLayer(layer.name)" class="text-[9px] px-1.5 py-0.5 rounded bg-red-900/30 hover:bg-red-900/50 text-red-400 whitespace-nowrap">Reset</button>
                                </div>
                            </div>
                        </div>

                        <!-- Observer + ER1 Status Row -->
                        <div class="grid grid-cols-2 gap-3">
                            <!-- Observer -->
                            <div class="border border-gray-700 rounded-lg p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-[10px] uppercase text-cyan-400 tracking-wider font-bold">Observer</span>
                                    <span class="text-[10px] px-1.5 py-0.5 rounded" :class="memoryObserver.enabled ? 'bg-green-900/40 text-green-400' : 'bg-gray-800 text-gray-500'">{{ memoryObserver.enabled ? 'ON' : 'OFF' }}</span>
                                </div>
                                <div class="space-y-1 text-[10px] text-gray-400">
                                    <div>Observations: <span class="text-gray-200">{{ memoryObserver.observation_count }}</span></div>
                                    <div>Queue depth: <span class="text-gray-200">{{ memoryObserver.queue_depth }}</span></div>
                                    <div v-if="memoryObserver.last_observation">Last: <span class="text-gray-200">{{ new Date(memoryObserver.last_observation).toLocaleString() }}</span></div>
                                </div>
                            </div>
                            <!-- ER1 -->
                            <div class="border border-gray-700 rounded-lg p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-[10px] uppercase text-amber-400 tracking-wider font-bold">ER1 Sync</span>
                                    <span class="text-[10px] px-1.5 py-0.5 rounded" :class="memoryER1.connected ? 'bg-green-900/40 text-green-400' : 'bg-gray-800 text-gray-500'">{{ memoryER1.connected ? 'CONNECTED' : 'OFF' }}</span>
                                </div>
                                <div class="space-y-1 text-[10px] text-gray-400">
                                    <div>Synced items: <span class="text-gray-200">{{ memoryER1.synced_count }}</span></div>
                                    <div v-if="memoryER1.last_sync">Last sync: <span class="text-gray-200">{{ new Date(memoryER1.last_sync).toLocaleString() }}</span></div>
                                    <div v-if="memoryER1.url">URL: <span class="text-gray-300">{{ memoryER1.url }}</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- Expertise -->
                        <div v-if="memoryExpertise.length > 0">
                            <div class="text-[10px] uppercase text-gray-500 tracking-wider mb-2">Expertise Tracking</div>
                            <div class="border border-gray-700 rounded-lg p-3 space-y-2">
                                <div v-for="skill in memoryExpertise" :key="skill.skill" class="flex items-center gap-2">
                                    <span class="text-[10px] text-gray-300 w-20 truncate" :title="skill.skill">{{ skill.skill }}</span>
                                    <div class="flex-1 mem-gauge-bar">
                                        <div class="mem-gauge-fill" :style="{ width: (skill.score * 100) + '%', background: skill.trend === 'improving' ? '#22c55e' : skill.trend === 'declining' ? '#f85149' : '#58a6ff' }"></div>
                                    </div>
                                    <span class="text-[10px] text-gray-400 w-10 text-right">{{ Math.round(skill.score * 100) }}%</span>
                                    <span class="text-[9px] w-6" :class="skill.trend === 'improving' ? 'text-green-400' : skill.trend === 'declining' ? 'text-red-400' : 'text-gray-500'">{{ skill.trend === 'improving' ? '&#x25B2;' : skill.trend === 'declining' ? '&#x25BC;' : '&#x2500;' }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Working Memory -->
                        <div v-if="memoryWorkingMemory.entries > 0">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-[10px] uppercase text-gray-500 tracking-wider">Working Memory <span class="text-gray-400">({{ memoryWorkingMemory.entries }} entries)</span></div>
                                <button @click="memoryResetLayer('working_memory')" class="text-[9px] px-1.5 py-0.5 rounded bg-red-900/30 hover:bg-red-900/50 text-red-400">Reset</button>
                            </div>
                            <div class="border border-gray-700 rounded-lg p-3">
                                <pre class="text-[10px] text-gray-300 whitespace-pre-wrap max-h-32 overflow-y-auto">{{ memoryWorkingMemory.preview || '(empty)' }}</pre>
                            </div>
                        </div>

                        <!-- Reset All -->
                        <div class="pt-2 border-t border-gray-800 flex items-center justify-between">
                            <div class="text-[10px] text-gray-500">Danger zone: irreversible actions</div>
                            <div class="flex items-center gap-2">
                                <button @click="memoryResetAll" class="text-[10px] px-3 py-1 rounded bg-red-900/40 hover:bg-red-900/60 text-red-400 border border-red-800/50">Reset All Memory</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Memory Reset Confirmation -->
            <div v-if="memoryConfirmVisible" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50"
                @click.self="memoryConfirmVisible = false">
                <div class="glass rounded-xl border border-red-800/50 p-6 shadow-2xl" style="width: 400px; max-width: 90vw;">
                    <div class="text-sm font-bold text-red-400 mb-3">Confirm Reset</div>
                    <div class="text-xs text-gray-300 mb-4">{{ memoryConfirmMessage }}</div>
                    <div class="flex justify-end gap-2">
                        <button @click="memoryConfirmVisible = false" class="text-xs px-3 py-1.5 rounded bg-gray-700 hover:bg-gray-600 text-white">Cancel</button>
                        <button @click="memoryConfirmAction" class="text-xs px-3 py-1.5 rounded bg-red-700 hover:bg-red-600 text-white">Confirm Reset</button>
                    </div>
                </div>
            </div>

        </main>


    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick } = Vue
        const GithubPanel = {
            props: {
                visible: Boolean,
                floating: Boolean,
                panel: Object,
                panelEl: [Object, Function, String],
                title: String,
                titleClass: String,
                iconClass: String,
                iconGlowClass: String,
                floatable: Boolean,
                refreshable: Boolean,
                resizable: Boolean,
                maxHeight: { type: String, default: 'calc(100vh - 140px)' }
            },
            emits: ['toggle-float', 'refresh', 'close', 'drag', 'resize'],
            template: `
                <div v-if="visible" :ref="panelEl"
                    class="glass rounded-xl border border-gray-700 overflow-hidden w-full"
                    :class="floating ? 'fixed z-30 shadow-2xl resize' : 'resize-y'"
                    :style="floating ? { left: panel.x + 'px', top: panel.y + 'px', width: panel.w + 'px', height: panel.h + 'px' } : { maxHeight: maxHeight, overflowY: 'auto', minHeight: '120px' }">
                    <div class="absolute inset-0 pointer-events-none"
                        style="background: linear-gradient(135deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.02) 30%, rgba(255,255,255,0.08) 55%, rgba(255,255,255,0.01) 80%); mix-blend-mode: screen;"></div>
                    <div class="p-4 border-b border-gray-800 sticky top-0 bg-[#0d1117]/80 backdrop-blur"
                        :class="floating ? 'cursor-move select-none' : ''" @mousedown="$emit('drag', $event)">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center" :class="iconClass">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" :class="iconGlowClass" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 .5C5.7.5.5 5.7.5 12c0 5.1 3.3 9.4 7.9 10.9.6.1.8-.3.8-.6v-2.1c-3.2.7-3.9-1.4-3.9-1.4-.5-1.2-1.2-1.5-1.2-1.5-1-.7.1-.7.1-.7 1.1.1 1.7 1.1 1.7 1.1 1 .1.8 2.2 2.9 2.3.1-.7.4-1.2.7-1.5-2.6-.3-5.4-1.3-5.4-6 0-1.3.5-2.4 1.2-3.2-.1-.3-.5-1.5.1-3.1 0 0 1-.3 3.3 1.2 1-.3 2-.4 3-.4s2 .1 3 .4c2.3-1.5 3.3-1.2 3.3-1.2.6 1.6.2 2.8.1 3.1.8.8 1.2 1.9 1.2 3.2 0 4.7-2.8 5.7-5.4 6 .4.3.8 1 .8 2.1v3.1c0 .3.2.7.8.6 4.6-1.5 7.9-5.8 7.9-10.9C23.5 5.7 18.3.5 12 .5z"/>
                                    </svg>
                                </div>
                                <div :class="titleClass">{{ title }}</div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button v-if="floatable" @click.stop="$emit('toggle-float')"
                                    class="text-xs px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">
                                    {{ floating ? 'Dock' : 'Float' }}
                                </button>
                                <button v-if="refreshable" @click.stop="$emit('refresh')"
                                    class="text-xs px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">Refresh</button>
                                <button @click.stop="$emit('close')" title="Close"
                                    class="text-xs px-2 py-1 rounded bg-[#3b1118] hover:bg-[#6b1f2c] text-white shadow-none hover:shadow-[0_0_14px_rgba(200,80,110,0.85)]">✕</button>
                            </div>
                        </div>
                        <slot name="header"></slot>
                    </div>
                    <div class="p-4">
                        <slot></slot>
                    </div>
                    <div v-if="floating && resizable"
                        class="absolute bottom-2 right-2 w-4 h-4 cursor-se-resize opacity-70 hover:opacity-100"
                        @mousedown.stop="$emit('resize', $event)">
                        <div class="w-4 h-4 border-r-2 border-b-2 border-dashed border-gray-500"></div>
                    </div>
                </div>
            `
        }

        const app = createApp({
            setup() {
                const events = ref([])
                const selectedUser = ref("")
                const authFilter = ref("authorized")
                const silentMode = ref(true) // Default: safe (silent)
                const showTechnical = ref(false) // Default: user-centric
                const webUsers = ref([])
                const selectedWebUserId = ref("")
                const newWebUserName = ref("")
                const linkJid = ref("")
                const webChatMessage = ref("")
                const webStatus = ref("")
                const systemCopyStatus = ref("")
                const repoActionStatus = ref("")
                const repoActionOk = ref(null)
                const repoActionAt = ref("")
                const repoHover = ref(false)
                const repoHoverStyle = ref({ left: '0px', top: '0px' })
                const repoPanelVisible = ref(false)
                const identityPanelVisible = ref(false)
                const configOpen = ref(false)
                const configStatus = ref("")
                const configTab = ref("paths")
                const configTabs = [
                    { id: "paths", label: "Paths" },
                    { id: "whatsapp", label: "WhatsApp" },
                    { id: "policy", label: "Policy" },
                    { id: "integrations", label: "Integrations" },
                ]
                const cfgBotRepoPath = ref("")
                const identityRepoPath = ref("")
                const cfgDefaultWorkRepoPath = ref("")
                const cfgDefaultRepoSearchPath = ref("")
                const cfgKafScaleProxyUrl = ref("")
                const cfgAuthFilterDefault = ref("authorized")
                const cfgWhatsAppToken = ref("")
                const cfgWhatsAppAllowlist = ref("")
                const cfgWhatsAppDenylist = ref("")
                const cfgWhatsAppPending = ref("")
                const traceOpen = ref(false)
                const tracePanelVisible = ref(false)
                const traceMeta = ref({ traceId: "", channel: "" })
                const traceSpans = ref([])
                const selectedSpan = ref(null)
                const traceFloating = ref(false)
                const traceViewMode = ref('list')
                const traceGraphSvg = ref(null)
                const appMode = ref('')
                const groupPanelVisible = ref(false)
                const groupStatus = ref({ active: false, group_name: '', member_count: 0, lfs_healthy: false })
                const groupMembers = ref([])
                const tracePanel = ref({ x: 400, y: 80, w: 460, h: 600 })
                const tracePanelEl = ref(null)
                const identityPanel = ref({ x: 120, y: 120, w: 460, h: 240 })
                const identityPanelEl = ref(null)
                const identityFloating = ref(false)
                const draggingTrace = ref(false)
                const resizingTrace = ref(false)
                const traceDragOffset = ref({ x: 0, y: 0 })
                const forceSend = ref(true)
                const clipboardOpen = ref(false)
                const clipboardItems = ref([])
                const clipboardSelected = ref([])
                const workRepoPath = ref("")
                const repoOptions = ref([])
                const selectedRepoPath = ref("")
                const defaultWorkRepoPath = ref("")
                const activeRepoChoice = ref("")
                const repoScanStatus = ref("")
                const repoTree = ref([])
                const repoFileContent = ref("")
                const repoFileDiff = ref("")
                const repoDiff = ref("")
                const repoStatus = ref("")
                const repoStatusError = ref("")
                const repoRemoteInfo = ref("")
                const repoCommitMessage = ref("")
                const repoRemoteUrl = ref("")
                const ghAuthStatus = ref("")
                const repoBranches = ref([])
                const selectedBranch = ref("")
                const repoCommits = ref([])
                const prTitle = ref("")
                const prBody = ref("")
                const prBase = ref("")
                const prHead = ref("")
                const prDraft = ref(false)
                const repoTab = ref("files")
                const repoFloating = ref(false)
                const repoPanel = ref({ x: 24, y: 120, w: 520, h: 640 })
                const repoFloatState = ref(false)
                const draggingRepo = ref(false)
                const resizingRepo = ref(false)
                const dragOffset = ref({ x: 0, y: 0 })
                const repoPanelEl = ref(null)

                // Identity repo state
                const idQ = '?repo=identity'
                const idRepoTree = ref([])
                const idRepoFileContent = ref("")
                const idRepoFileDiff = ref("")
                const idRepoDiff = ref("")
                const idRepoStatus = ref("")
                const idRepoStatusError = ref("")
                const idRepoRemoteInfo = ref("")
                const idRepoCommitMessage = ref("")
                const idRepoRemoteUrl = ref("")
                const idGhAuthStatus = ref("")
                const idRepoBranches = ref([])
                const idSelectedBranch = ref("")
                const idRepoCommits = ref([])
                const idPrTitle = ref("")
                const idPrBody = ref("")
                const idPrBase = ref("")
                const idPrHead = ref("")
                const idPrDraft = ref(false)
                const idRepoTab = ref("files")
                const idRepoActionStatus = ref("")
                const idRepoActionOk = ref(null)
                const idRepoActionAt = ref("")

                // Tasks panel state
                const tasksPanelVisible = ref(false)
                const tasksList = ref([])
                const selectedTask = ref(null)
                const tasksFilterStatus = ref("")
                const tasksFilterChannel = ref("")

                // Hardening config state
                const cfgDailyTokenLimit = ref("0")
                const cfgMaxAutoTier = ref("2")

                // Memory Manager state
                const memoryPanelVisible = ref(false)
                const memoryLayers = ref([])
                const memoryObserver = ref({ enabled: false, observation_count: 0, queue_depth: 0, last_observation: '' })
                const memoryER1 = ref({ connected: false, synced_count: 0, last_sync: '', url: '' })
                const memoryExpertise = ref([])
                const memoryWorkingMemory = ref({ entries: 0, preview: '' })
                const memoryTotalChunks = ref(0)
                const memoryMaxChunks = ref(50000)
                const memoryUsagePercent = computed(() => {
                    if (memoryMaxChunks.value === 0) return 0
                    return Math.min(100, Math.round((memoryTotalChunks.value / memoryMaxChunks.value) * 100))
                })
                const memoryActionStatus = ref('')
                const memoryActionOk = ref(true)
                const memoryConfirmVisible = ref(false)
                const memoryConfirmMessage = ref('')
                let memoryConfirmCallback = null

                // Trace enhancements
                const traceTaskInfo = ref(null)
                const tracePolicyDecisions = ref([])
                const traceJsonCopied = ref(false)

                const copyTraceJson = async () => {
                    const spans = traceSpans.value.map(s => ({
                        type: s.type,
                        time: s.time,
                        duration: s.duration || '',
                        title: s.title || s.type,
                        metadata: s.metadata || {}
                    }))
                    const hasToolSpans = spans.some(s => s.type === 'TOOL')
                    const hasReadFile = spans.some(s => s.type === 'TOOL' && s.metadata && s.metadata.tool_name === 'read_file')
                    const exportObj = {
                        trace_id: traceMeta.value.traceId || '',
                        exported_at: new Date().toISOString(),
                        spans,
                        task: traceTaskInfo.value ? {
                            task_id: traceTaskInfo.value.task_id,
                            status: traceTaskInfo.value.status,
                            prompt_tokens: traceTaskInfo.value.prompt_tokens,
                            completion_tokens: traceTaskInfo.value.completion_tokens,
                            total_tokens: traceTaskInfo.value.total_tokens,
                            channel: traceMeta.value.channel || ''
                        } : null,
                        policy_decisions: tracePolicyDecisions.value || [],
                        analysis: {
                            used_tools: hasToolSpans,
                            data_source: hasReadFile ? 'file_read' : (hasToolSpans ? 'tool_assisted' : 'llm_context_only'),
                            span_count: spans.length,
                            llm_iterations: spans.filter(s => s.type === 'LLM').length
                        }
                    }
                    try {
                        await navigator.clipboard.writeText(JSON.stringify(exportObj, null, 2))
                        traceJsonCopied.value = true
                        setTimeout(() => { traceJsonCopied.value = false }, 2000)
                    } catch (e) {
                        console.error('Failed to copy trace JSON', e)
                    }
                }

                // Load silent mode from server
                const loadSilentMode = async () => {
                    try {
                        const res = await fetch('/api/v1/settings?key=silent_mode')
                        const data = await res.json()
                        silentMode.value = data.value === '' || data.value === 'true' // default true
                    } catch (e) { console.error('Failed to load silent mode', e) }
                }

                // Toggle and persist
                const toggleSilent = async () => {
                    try {
                        await fetch('/api/v1/settings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ key: 'silent_mode', value: String(silentMode.value) })
                        })
                    } catch (e) { console.error('Failed to save silent mode', e) }
                }

                // Computed unique senders (excluding AGENT/SYSTEM implicitly, usually empty sender or specific ID)
                const senders = computed(() => {
                    const s = new Set(events.value.filter(e => e.event_type !== 'SYSTEM' && !e.event_id.includes('_ACK')).map(e => e.sender_id))
                    return Array.from(s).sort()
                })

                // Determine if event is from Bot
                const isBot = (e) => e.event_type === 'SYSTEM' || e.event_id.endsWith('_ACK')

                const isTechnical = (e) => {
                    if (!e) return false
                    if (e.event_type === 'SYSTEM') return true
                    const cls = (e.classification || '').toUpperCase()
                    return cls.includes('OUTBOUND') || cls.includes('WEBUI_') || cls.includes('LOCAL_') || cls.includes('WHATSAPP_')
                }

                // Determine dot color
                const getDotClass = (e) => {
                    if (e.classification === 'EMERGENCY') return 'bg-red-500 shadow-[0_0_10px_red]'
                    if (e.event_type === 'SYSTEM') return 'bg-blue-500'
                    if (!e.authorized) return 'bg-yellow-500' // Unauthorized indicator
                    return 'bg-green-500'
                }

                const spanTypeColorHex = (type) => {
                    const m = { INBOUND: '#58a6ff', LLM: '#a855f7', TOOL: '#fb923c', OUTBOUND: '#22c55e', POLICY: '#ef4444' }
                    return m[type] || '#6366f1'
                }

                const fetchData = async () => {
                    try {
                        const res = await fetch('/api/v1/timeline?limit=200')
                        events.value = await res.json() || []
                    } catch (e) {
                        console.error(e)
                    }
                }

                const loadWebUsers = async () => {
                    try {
                        const res = await fetch('/api/v1/webusers')
                        const text = await res.text()
                        if (!text || text.trim() === '') {
                            webUsers.value = []
                            return
                        }
                        webUsers.value = JSON.parse(text) || []
                        if (selectedWebUserId.value) {
                            const selected = webUsers.value.find(u => String(u.id) === String(selectedWebUserId.value))
                            if (selected && typeof selected.force_send === 'boolean') {
                                forceSend.value = selected.force_send
                            } else {
                                forceSend.value = true
                            }
                        }
                    } catch (e) {
                        console.error('Failed to load web users', e)
                    }
                }

                const createWebUser = async () => {
                    const name = newWebUserName.value.trim()
                    if (!name) return
                    try {
                        const res = await fetch('/api/v1/webusers', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name })
                        })
                        const text = await res.text()
                        const user = text ? JSON.parse(text) : {}
                        await loadWebUsers()
                        selectedWebUserId.value = String(user.id || "")
                        forceSend.value = true
                        newWebUserName.value = ""
                        await loadWebLink()
                    } catch (e) {
                        console.error('Failed to create web user', e)
                    }
                }

                const loadWebLink = async () => {
                    linkJid.value = ""
                    if (!selectedWebUserId.value) return
                    try {
                        const res = await fetch(`/api/v1/weblinks?web_user_id=${selectedWebUserId.value}`)
                        const data = await res.json()
                        linkJid.value = data.whatsapp_jid || ""
                        const selected = webUsers.value.find(u => String(u.id) === String(selectedWebUserId.value))
                        if (selected && typeof selected.force_send === 'boolean') {
                            forceSend.value = selected.force_send
                        } else {
                            forceSend.value = true
                        }
                    } catch (e) {
                        console.error('Failed to load web link', e)
                    }
                }

                const saveForceSend = async () => {
                    if (!selectedWebUserId.value) return
                    try {
                        await fetch('/api/v1/webusers/force', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ web_user_id: Number(selectedWebUserId.value), force_send: !!forceSend.value })
                        })
                        await loadWebUsers()
                    } catch (e) {
                        console.error('Failed to update force send', e)
                    }
                }

                const saveWebLink = async () => {
                    if (!selectedWebUserId.value) return
                    try {
                        await fetch('/api/v1/weblinks', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ web_user_id: Number(selectedWebUserId.value), whatsapp_jid: linkJid.value.trim() })
                        })
                    } catch (e) {
                        console.error('Failed to save web link', e)
                    }
                }

                const unlinkWebLink = async () => {
                    if (!selectedWebUserId.value) return
                    try {
                        await fetch('/api/v1/weblinks', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ web_user_id: Number(selectedWebUserId.value), whatsapp_jid: "" })
                        })
                        linkJid.value = ""
                    } catch (e) {
                        console.error('Failed to unlink web link', e)
                    }
                }

                const sendWebChat = async () => {
                    if (!selectedWebUserId.value) {
                        webStatus.value = "Select a web user first"
                        return
                    }
                    if (!webChatMessage.value.trim()) return
                    try {
                        webStatus.value = "Sending..."
                        await fetch('/api/v1/webchat/send', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ web_user_id: Number(selectedWebUserId.value), message: webChatMessage.value })
                        })
                        webChatMessage.value = ""
                        webStatus.value = "Queued"
                        fetchData()
                    } catch (e) {
                        webStatus.value = "Send failed"
                        console.error('Failed to send web chat', e)
                    }
                }

                const copyWebChat = async () => {
                    try {
                        await navigator.clipboard.writeText(webChatMessage.value || "")
                        webStatus.value = "Copied"
                        addClipboardItem(webChatMessage.value || "")
                    } catch (e) {
                        console.error('Failed to copy', e)
                        webStatus.value = "Copy failed"
                    }
                }

                const copyMessage = async (text) => {
                    try {
                        await navigator.clipboard.writeText(text || "")
                        webStatus.value = "Copied"
                        addClipboardItem(text || "")
                    } catch (e) {
                        console.error('Failed to copy message', e)
                        webStatus.value = "Copy failed"
                    }
                }

                const copyMessageSystem = async (text, senderLabel) => {
                    try {
                        await navigator.clipboard.writeText(text || "")
                        const ts = new Date().toLocaleTimeString()
                        const sender = senderLabel || "Unknown"
                        systemCopyStatus.value = `Copied to system clipboard (${ts} ${sender})`
                    } catch (e) {
                        console.error('Failed to copy message to system', e)
                        webStatus.value = "Copy failed"
                    }
                }

                const reprocessMessage = async (event) => {
                    if (!event || !event.content_text) return
                    let webUserId = selectedWebUserId.value
                    if (!webUserId && event.sender_id) {
                        const sid = String(event.sender_id)
                        if (sid.startsWith('webui:')) {
                            const name = sid.replace('webui:', '')
                            const match = webUsers.value.find(u => u.name === name)
                            if (match) {
                                webUserId = match.id
                            }
                        }
                    }
                    if (!webUserId) {
                        webStatus.value = "Select web user to reprocess"
                        return
                    }
                    const replayEvent = {
                        id: `replay-${Date.now()}`,
                        event_id: `REPLAY_${Date.now()}`,
                        timestamp: new Date().toISOString(),
                        sender_id: event.sender_id || `webui:${webUserId}`,
                        sender_name: event.sender_name || "Replay",
                        event_type: event.event_type || "TEXT",
                        content_text: event.content_text,
                        media_path: event.media_path || "",
                        vector_id: "",
                        classification: "REPLAY",
                        authorized: true,
                        replay: true,
                    }
                    events.value = [replayEvent, ...events.value]
                    try {
                        const res = await fetch('/api/v1/webchat/send', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ web_user_id: Number(webUserId), message: event.content_text })
                        })
                        if (!res.ok) {
                            webStatus.value = "Reprocess failed"
                            return
                        }
                        webStatus.value = "Reprocess queued"
                        fetchData()
                    } catch (e) {
                        console.error('Failed to reprocess message', e)
                        webStatus.value = "Reprocess failed"
                    }
                }

                const loadClipboard = () => {
                    try {
                        const raw = localStorage.getItem('kafclaw_clipboard') || '[]'
                        clipboardItems.value = JSON.parse(raw) || []
                    } catch (e) {
                        clipboardItems.value = []
                    }
                }

                const saveClipboard = () => {
                    localStorage.setItem('kafclaw_clipboard', JSON.stringify(clipboardItems.value))
                }

                const addClipboardItem = (text) => {
                    if (!text) return
                    const item = { id: String(Date.now()) + Math.random().toString(36).slice(2), text, ts: Date.now() }
                    clipboardItems.value = [item, ...clipboardItems.value].slice(0, 100)
                    saveClipboard()
                }

                const toggleClipboard = () => {
                    clipboardOpen.value = !clipboardOpen.value
                    if (clipboardOpen.value) {
                        loadClipboard()
                    }
                }

                const selectAllClipboard = () => {
                    clipboardSelected.value = clipboardItems.value.map(i => i.id)
                }

                const clearClipboard = () => {
                    clipboardItems.value = []
                    clipboardSelected.value = []
                    saveClipboard()
                }

                const removeClipboardItem = (id) => {
                    clipboardItems.value = clipboardItems.value.filter(i => i.id !== id)
                    clipboardSelected.value = clipboardSelected.value.filter(i => i !== id)
                    saveClipboard()
                }

                const deleteSelectedClipboard = () => {
                    const set = new Set(clipboardSelected.value)
                    clipboardItems.value = clipboardItems.value.filter(i => !set.has(i.id))
                    clipboardSelected.value = []
                    saveClipboard()
                }

                const copySelectedClipboard = async () => {
                    const set = new Set(clipboardSelected.value)
                    const texts = clipboardItems.value.filter(i => set.has(i.id)).map(i => i.text)
                    try {
                        await navigator.clipboard.writeText(texts.join("\n\n"))
                        webStatus.value = "Copied"
                    } catch (e) {
                        console.error('Failed to copy selected', e)
                        webStatus.value = "Copy failed"
                    }
                }

                const loadWorkRepo = async () => {
                    try {
                        const res = await fetch('/api/v1/workrepo')
                        const data = await res.json()
                        workRepoPath.value = data.path || ""
                    } catch (e) {
                        console.error('Failed to load work repo', e)
                    }
                }

                const saveWorkRepo = async () => {
                    if (!workRepoPath.value.trim()) return
                    try {
                        const res = await fetch('/api/v1/workrepo', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ path: workRepoPath.value })
                        })
                        const data = await res.json()
                        workRepoPath.value = data.path || workRepoPath.value
                        webStatus.value = "Repo set"
                        repoFileContent.value = ""
                        repoFileDiff.value = ""
                        await refreshRepo()
                    } catch (e) {
                        console.error('Failed to save work repo', e)
                        webStatus.value = "Repo set failed"
                    }
                }

                const loadRepoOptions = async () => {
                    try {
                        repoScanStatus.value = "Scanning..."
                        repoOptions.value = []
                        const res = await fetch('/api/v1/repo/search')
                        const data = await res.json()
                        const repos = data.repos || []
                        repoOptions.value = repos.map((p) => {
                            const parts = String(p).split('/')
                            const name = parts[parts.length - 1] || p
                            return { name, path: p }
                        })
                        repoScanStatus.value = `Found ${repoOptions.value.length} · ${new Date().toLocaleTimeString()}`
                    } catch (e) {
                        console.error('Failed to load repo options', e)
                        repoScanStatus.value = "Scan failed"
                    }
                }

                const loadDefaultWorkRepoPath = async () => {
                    try {
                        const res = await fetch('/api/v1/settings?key=default_work_repo_path')
                        const data = await res.json()
                        defaultWorkRepoPath.value = data.value || ""
                    } catch (e) {
                        console.error('Failed to load default work repo path', e)
                    }
                }

                const useSelectedRepo = async () => {
                    if (!selectedRepoPath.value) return
                    activeRepoChoice.value = "selected"
                    workRepoPath.value = selectedRepoPath.value
                    try {
                        await fetch('/api/v1/settings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ key: "selected_repo_path", value: selectedRepoPath.value }),
                        })
                    } catch (e) {
                        console.error('Failed to persist selected repo', e)
                    }
                    await saveWorkRepo()
                }

                const useDefaultRepo = async () => {
                    if (!defaultWorkRepoPath.value) return
                    activeRepoChoice.value = "default"
                    workRepoPath.value = defaultWorkRepoPath.value
                    try {
                        await fetch('/api/v1/settings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ key: "selected_repo_path", value: defaultWorkRepoPath.value }),
                        })
                    } catch (e) {
                        console.error('Failed to persist default repo', e)
                    }
                    await saveWorkRepo()
                }

                const refreshRepo = async () => {
                    await loadWorkRepo()
                    await loadRepoTree()
                    await loadRepoStatus()
                    await loadRepoLog()
                    await loadRepoBranches()
                    await loadGhAuth()
                    await loadRepoDiff()
                }

                const refreshAll = async () => {
                    await fetchData()
                    await loadRepoOptions()
                    await refreshRepo()
                }

                // Mode switching — works in Electron (via IPC) and browser (via navigation)
                const switchMode = async () => {
                    if (window.electronAPI && window.electronAPI.mode && window.electronAPI.mode.reset) {
                        await window.electronAPI.mode.reset()
                    } else {
                        // Browser fallback: just reload
                        window.location.reload()
                    }
                }

                const loadRepoTree = async () => {
                    try {
                        const res = await fetch('/api/v1/repo/tree')
                        repoTree.value = await res.json() || []
                    } catch (e) {
                        console.error('Failed to load repo tree', e)
                    }
                }

                const selectRepoItem = async (item) => {
                    if (!item || item.type === 'dir') return
                    try {
                        const res = await fetch(`/api/v1/repo/file?path=${encodeURIComponent(item.path)}`)
                        const data = await res.json()
                        repoFileContent.value = data.content || ""
                        const diffRes = await fetch(`/api/v1/repo/diff-file?path=${encodeURIComponent(item.path)}`)
                        const diffData = await diffRes.json()
                        repoFileDiff.value = diffData.diff || ""
                    } catch (e) {
                        console.error('Failed to load file', e)
                    }
                }

                const loadRepoStatus = async () => {
                    try {
                        const res = await fetch('/api/v1/repo/status')
                        const data = await res.json()
                        repoStatus.value = data.status || ""
                        repoStatusError.value = data.error || ""
                        repoRemoteInfo.value = data.remote || ""
                    } catch (e) {
                        console.error('Failed to load repo status', e)
                    }
                }

                const loadRepoDiff = async () => {
                    try {
                        const res = await fetch('/api/v1/repo/diff')
                        const data = await res.json()
                        repoDiff.value = data.diff || ""
                    } catch (e) {
                        console.error('Failed to load repo diff', e)
                    }
                }

                const loadRepoLog = async () => {
                    try {
                        const res = await fetch('/api/v1/repo/log?limit=50')
                        const data = await res.json()
                        repoCommits.value = data.commits || []
                    } catch (e) {
                        console.error('Failed to load repo log', e)
                    }
                }

                const loadRepoBranches = async () => {
                    try {
                        const res = await fetch('/api/v1/repo/branches')
                        const data = await res.json()
                        repoBranches.value = data.branches || []
                    } catch (e) {
                        console.error('Failed to load branches', e)
                    }
                }

                const checkoutBranch = async () => {
                    if (!selectedBranch.value) return
                    try {
                        const res = await fetch('/api/v1/repo/checkout', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ branch: selectedBranch.value })
                        })
                        await res.json()
                        await refreshRepo()
                    } catch (e) {
                        console.error('Checkout failed', e)
                    }
                }

                const loadGhAuth = async () => {
                    try {
                        const res = await fetch('/api/v1/repo/gh-auth')
                        const data = await res.json()
                        ghAuthStatus.value = data.detail || data.status || ""
                    } catch (e) {
                        console.error('Failed to load gh auth', e)
                    }
                }

                const commitRepo = async () => {
                    if (!repoCommitMessage.value.trim()) {
                        repoCommitMessage.value = "Update"
                    }
                    try {
                        const res = await fetch('/api/v1/repo/commit', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: repoCommitMessage.value })
                        })
                        const data = await res.json()
                        if (!res.ok) {
                            throw new Error(data.error || data.result || "Commit failed")
                        }
                        repoStatus.value = data.result || repoStatus.value
                        repoCommitMessage.value = ""
                        repoActionStatus.value = "Commit OK"
                        repoActionOk.value = true
                        repoActionAt.value = new Date().toLocaleTimeString()
                        await refreshRepo()
                    } catch (e) {
                        console.error('Commit failed', e)
                        repoActionStatus.value = "Commit failed"
                        repoActionOk.value = false
                        repoActionAt.value = new Date().toLocaleTimeString()
                    }
                }

                const pullRepo = async () => {
                    try {
                        const res = await fetch('/api/v1/repo/pull', { method: 'POST' })
                        const data = await res.json()
                        repoStatus.value = data.result || repoStatus.value
                        repoActionStatus.value = "Pull OK"
                        repoActionOk.value = true
                        repoActionAt.value = new Date().toLocaleTimeString()
                        await refreshRepo()
                    } catch (e) {
                        console.error('Pull failed', e)
                        repoActionStatus.value = "Pull failed"
                        repoActionOk.value = false
                        repoActionAt.value = new Date().toLocaleTimeString()
                    }
                }

                const pushRepo = async () => {
                    try {
                        const res = await fetch('/api/v1/repo/push', { method: 'POST' })
                        const data = await res.json()
                        repoStatus.value = data.result || repoStatus.value
                        repoActionStatus.value = "Push OK"
                        repoActionOk.value = true
                        repoActionAt.value = new Date().toLocaleTimeString()
                        await refreshRepo()
                    } catch (e) {
                        console.error('Push failed', e)
                        repoActionStatus.value = "Push failed"
                        repoActionOk.value = false
                        repoActionAt.value = new Date().toLocaleTimeString()
                    }
                }

                const initRepo = async () => {
                    try {
                        const res = await fetch('/api/v1/repo/init', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ remote_url: repoRemoteUrl.value })
                        })
                        await res.json()
                        repoActionStatus.value = "Init OK"
                        repoActionOk.value = true
                        repoActionAt.value = new Date().toLocaleTimeString()
                        await refreshRepo()
                    } catch (e) {
                        console.error('Init failed', e)
                        repoActionStatus.value = "Init failed"
                        repoActionOk.value = false
                        repoActionAt.value = new Date().toLocaleTimeString()
                    }
                }

                const createPr = async () => {
                    if (!prTitle.value.trim()) return
                    try {
                        const res = await fetch('/api/v1/repo/pr', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title: prTitle.value, body: prBody.value, base: prBase.value, head: prHead.value, draft: prDraft.value })
                        })
                        const data = await res.json()
                        repoActionStatus.value = data.result ? "PR created" : "PR failed"
                        repoActionOk.value = !!data.result
                        repoActionAt.value = new Date().toLocaleTimeString()
                    } catch (e) {
                        console.error('PR failed', e)
                        repoActionStatus.value = "PR failed"
                        repoActionOk.value = false
                        repoActionAt.value = new Date().toLocaleTimeString()
                    }
                }

                // --- Identity Repo functions ---
                const refreshIdentity = async () => {
                    await loadIdRepoTree()
                    await loadIdRepoStatus()
                    await loadIdRepoLog()
                    await loadIdRepoBranches()
                    await loadIdGhAuth()
                    await loadIdRepoDiff()
                }
                const loadIdRepoTree = async () => {
                    try {
                        const res = await fetch('/api/v1/repo/tree' + idQ)
                        idRepoTree.value = await res.json() || []
                    } catch (e) { console.error('Failed to load id repo tree', e) }
                }
                const selectIdRepoItem = async (item) => {
                    if (!item || item.type === 'dir') return
                    try {
                        const res = await fetch(`/api/v1/repo/file${idQ}&path=${encodeURIComponent(item.path)}`)
                        const data = await res.json()
                        idRepoFileContent.value = data.content || ""
                        const diffRes = await fetch(`/api/v1/repo/diff-file${idQ}&path=${encodeURIComponent(item.path)}`)
                        const diffData = await diffRes.json()
                        idRepoFileDiff.value = diffData.diff || ""
                    } catch (e) { console.error('Failed to load id file', e) }
                }
                const loadIdRepoStatus = async () => {
                    try {
                        const res = await fetch('/api/v1/repo/status' + idQ)
                        const data = await res.json()
                        idRepoStatus.value = data.status || ""
                        idRepoStatusError.value = data.error || ""
                        idRepoRemoteInfo.value = data.remote || ""
                    } catch (e) { console.error('Failed to load id repo status', e) }
                }
                const loadIdRepoDiff = async () => {
                    try {
                        const res = await fetch('/api/v1/repo/diff' + idQ)
                        const data = await res.json()
                        idRepoDiff.value = data.diff || ""
                    } catch (e) { console.error('Failed to load id repo diff', e) }
                }
                const loadIdRepoLog = async () => {
                    try {
                        const res = await fetch('/api/v1/repo/log' + idQ + '&limit=50')
                        const data = await res.json()
                        idRepoCommits.value = data.commits || []
                    } catch (e) { console.error('Failed to load id repo log', e) }
                }
                const loadIdRepoBranches = async () => {
                    try {
                        const res = await fetch('/api/v1/repo/branches' + idQ)
                        const data = await res.json()
                        idRepoBranches.value = data.branches || []
                    } catch (e) { console.error('Failed to load id branches', e) }
                }
                const checkoutIdBranch = async () => {
                    if (!idSelectedBranch.value) return
                    try {
                        const res = await fetch('/api/v1/repo/checkout' + idQ, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ branch: idSelectedBranch.value })
                        })
                        await res.json()
                        await refreshIdentity()
                    } catch (e) { console.error('Id checkout failed', e) }
                }
                const loadIdGhAuth = async () => {
                    try {
                        const res = await fetch('/api/v1/repo/gh-auth' + idQ)
                        const data = await res.json()
                        idGhAuthStatus.value = data.detail || data.status || ""
                    } catch (e) { console.error('Failed to load id gh auth', e) }
                }
                const commitIdRepo = async () => {
                    if (!idRepoCommitMessage.value.trim()) idRepoCommitMessage.value = "Update"
                    try {
                        const res = await fetch('/api/v1/repo/commit' + idQ, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: idRepoCommitMessage.value })
                        })
                        const data = await res.json()
                        if (!res.ok) throw new Error(data.error || data.result || "Commit failed")
                        idRepoCommitMessage.value = ""
                        idRepoActionStatus.value = "Commit OK"
                        idRepoActionOk.value = true
                        idRepoActionAt.value = new Date().toLocaleTimeString()
                        await refreshIdentity()
                    } catch (e) {
                        console.error('Id commit failed', e)
                        idRepoActionStatus.value = "Commit failed"
                        idRepoActionOk.value = false
                        idRepoActionAt.value = new Date().toLocaleTimeString()
                    }
                }
                const pullIdRepo = async () => {
                    try {
                        const res = await fetch('/api/v1/repo/pull' + idQ, { method: 'POST' })
                        await res.json()
                        idRepoActionStatus.value = "Pull OK"
                        idRepoActionOk.value = true
                        idRepoActionAt.value = new Date().toLocaleTimeString()
                        await refreshIdentity()
                    } catch (e) {
                        console.error('Id pull failed', e)
                        idRepoActionStatus.value = "Pull failed"
                        idRepoActionOk.value = false
                        idRepoActionAt.value = new Date().toLocaleTimeString()
                    }
                }
                const pushIdRepo = async () => {
                    try {
                        const res = await fetch('/api/v1/repo/push' + idQ, { method: 'POST' })
                        await res.json()
                        idRepoActionStatus.value = "Push OK"
                        idRepoActionOk.value = true
                        idRepoActionAt.value = new Date().toLocaleTimeString()
                        await refreshIdentity()
                    } catch (e) {
                        console.error('Id push failed', e)
                        idRepoActionStatus.value = "Push failed"
                        idRepoActionOk.value = false
                        idRepoActionAt.value = new Date().toLocaleTimeString()
                    }
                }
                const initIdRepo = async () => {
                    try {
                        const res = await fetch('/api/v1/repo/init' + idQ, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ remote_url: idRepoRemoteUrl.value })
                        })
                        await res.json()
                        idRepoActionStatus.value = "Init OK"
                        idRepoActionOk.value = true
                        idRepoActionAt.value = new Date().toLocaleTimeString()
                        await refreshIdentity()
                    } catch (e) {
                        console.error('Id init failed', e)
                        idRepoActionStatus.value = "Init failed"
                        idRepoActionOk.value = false
                        idRepoActionAt.value = new Date().toLocaleTimeString()
                    }
                }
                const createIdPr = async () => {
                    if (!idPrTitle.value.trim()) return
                    try {
                        const res = await fetch('/api/v1/repo/pr' + idQ, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title: idPrTitle.value, body: idPrBody.value, base: idPrBase.value, head: idPrHead.value, draft: idPrDraft.value })
                        })
                        const data = await res.json()
                        idRepoActionStatus.value = data.result ? "PR created" : "PR failed"
                        idRepoActionOk.value = !!data.result
                        idRepoActionAt.value = new Date().toLocaleTimeString()
                    } catch (e) {
                        console.error('Id PR failed', e)
                        idRepoActionStatus.value = "PR failed"
                        idRepoActionOk.value = false
                        idRepoActionAt.value = new Date().toLocaleTimeString()
                    }
                }

                const showRepoTooltip = (e) => {
                    const target = e?.target
                    if (!target || !target.getBoundingClientRect) return
                    const rect = target.getBoundingClientRect()
                    repoHoverStyle.value = {
                        left: `${Math.min(rect.left, window.innerWidth - 360)}px`,
                        top: `${rect.bottom + 8}px`
                    }
                    repoHover.value = true
                }

                const hideRepoTooltip = () => {
                    repoHover.value = false
                }

                const showRepoPanel = () => {
                    repoPanelVisible.value = true
                    localStorage.setItem('kafclaw_repo_panel_visible', 'true')
                }

                const hideRepoPanel = () => {
                    repoPanelVisible.value = false
                    localStorage.setItem('kafclaw_repo_panel_visible', 'false')
                }

                const toggleRepoPanel = () => {
                    repoPanelVisible.value = !repoPanelVisible.value
                    localStorage.setItem('kafclaw_repo_panel_visible', repoPanelVisible.value ? 'true' : 'false')
                }

                const toggleIdentityPanel = () => {
                    identityPanelVisible.value = !identityPanelVisible.value
                    localStorage.setItem('kafclaw_identity_panel_visible', identityPanelVisible.value ? 'true' : 'false')
                    if (identityPanelVisible.value) refreshIdentity()
                }

                const hideIdentityPanel = () => {
                    identityPanelVisible.value = false
                    localStorage.setItem('kafclaw_identity_panel_visible', 'false')
                }

                const fetchSetting = async (key, timeoutMs = 2000) => {
                    const controller = new AbortController()
                    const timer = setTimeout(() => controller.abort(), timeoutMs)
                    try {
                        const res = await fetch(`/api/v1/settings?key=${encodeURIComponent(key)}`, { signal: controller.signal })
                        const data = await res.json()
                        return data.value || ""
                    } finally {
                        clearTimeout(timer)
                    }
                }

                const openConfig = async () => {
                    configOpen.value = true
                    configStatus.value = "Loading..."
                    try {
                        const results = await Promise.allSettled([
                            fetchSetting("bot_repo_path"),
                            fetchSetting("default_work_repo_path"),
                            fetchSetting("default_repo_search_path"),
                            fetchSetting("kafscale_lfs_proxy_url"),
                            fetchSetting("default_auth_filter"),
                            fetchSetting("whatsapp_pair_token"),
                            fetchSetting("whatsapp_allowlist"),
                            fetchSetting("whatsapp_denylist"),
                            fetchSetting("whatsapp_pending"),
                            fetchSetting("daily_token_limit"),
                            fetchSetting("max_auto_tier"),
                        ])
                        cfgBotRepoPath.value = results[0].status === "fulfilled" ? results[0].value : ""
                        identityRepoPath.value = cfgBotRepoPath.value
                        cfgDefaultWorkRepoPath.value = results[1].status === "fulfilled" ? results[1].value : ""
                        cfgDefaultRepoSearchPath.value = results[2].status === "fulfilled" ? results[2].value : ""
                        cfgKafScaleProxyUrl.value = results[3].status === "fulfilled" ? results[3].value : ""
                        cfgAuthFilterDefault.value = results[4].status === "fulfilled" && results[4].value ? results[4].value : "authorized"
                        cfgWhatsAppToken.value = results[5].status === "fulfilled" ? results[5].value : ""
                        cfgWhatsAppAllowlist.value = results[6].status === "fulfilled" ? results[6].value : ""
                        cfgWhatsAppDenylist.value = results[7].status === "fulfilled" ? results[7].value : ""
                        cfgWhatsAppPending.value = results[8].status === "fulfilled" ? results[8].value : ""
                        cfgDailyTokenLimit.value = results[9].status === "fulfilled" && results[9].value ? results[9].value : "0"
                        cfgMaxAutoTier.value = results[10].status === "fulfilled" && results[10].value ? results[10].value : "2"
                        const hasRejection = results.some(r => r.status === "rejected")
                        configStatus.value = hasRejection ? "Some values failed to load" : ""
                    } catch (e) {
                        console.error('Failed to load config', e)
                        configStatus.value = "Load failed"
                    }
                }

                const closeConfig = () => {
                    configOpen.value = false
                }

                const renderTraceGraph = async () => {
                    const svg = traceGraphSvg.value
                    if (!svg || !traceMeta.value.traceId) return
                    try {
                        const res = await fetch(`/api/v1/trace-graph/${encodeURIComponent(traceMeta.value.traceId)}`)
                        const data = await res.json()
                        const nodes = data.nodes || []
                        const edges = data.edges || []
                        if (!nodes.length) return

                        // Clear
                        d3.select(svg).selectAll('*').remove()

                        const g = new dagreD3.graphlib.Graph().setGraph({ rankdir: 'TB', ranksep: 50, nodesep: 30 }).setDefaultEdgeLabel(() => ({}))

                        nodes.forEach(n => {
                            const label = (n.title || n.type || 'span').substring(0, 30)
                            g.setNode(n.span_id || n.id, {
                                label: label,
                                class: 'type-' + (n.type || 'EVENT') + (n.agent_id && n.agent_id !== 'local' ? ' remote' : ''),
                                width: Math.max(label.length * 7.5, 80),
                                height: 32,
                                _data: n
                            })
                        })
                        edges.forEach(e => {
                            if (g.hasNode(e.source) && g.hasNode(e.target)) {
                                g.setEdge(e.source, e.target)
                            }
                        })
                        // If no edges, chain nodes sequentially
                        if (!edges.length && nodes.length > 1) {
                            for (let i = 0; i < nodes.length - 1; i++) {
                                const src = nodes[i].span_id || nodes[i].id
                                const tgt = nodes[i+1].span_id || nodes[i+1].id
                                if (g.hasNode(src) && g.hasNode(tgt)) g.setEdge(src, tgt)
                            }
                        }

                        const svgEl = d3.select(svg)
                        const inner = svgEl.append('g')
                        const render = new dagreD3.render()
                        render(inner, g)

                        // Fit to container
                        const graphWidth = g.graph().width || 200
                        const graphHeight = g.graph().height || 200
                        const containerWidth = svg.parentElement.clientWidth || 400
                        const containerHeight = svg.parentElement.clientHeight || 400
                        const scale = Math.min(containerWidth / (graphWidth + 40), containerHeight / (graphHeight + 40), 1.5)
                        const xOffset = (containerWidth - graphWidth * scale) / 2
                        const yOffset = 20

                        svgEl.attr('width', containerWidth).attr('height', containerHeight)
                        inner.attr('transform', `translate(${xOffset}, ${yOffset}) scale(${scale})`)

                        // Zoom
                        const zoom = d3.zoom().scaleExtent([0.2, 3]).on('zoom', (event) => {
                            inner.attr('transform', event.transform)
                        })
                        svgEl.call(zoom)
                        svgEl.call(zoom.transform, d3.zoomIdentity.translate(xOffset, yOffset).scale(scale))

                        // Click handler
                        svgEl.selectAll('.node').on('click', function(event) {
                            const nodeId = d3.select(this).attr('id') || d3.select(this).datum()
                            const nodeData = g.node(nodeId)
                            if (nodeData && nodeData._data) {
                                selectedSpan.value = {
                                    id: nodeData._data.id,
                                    type: nodeData._data.type,
                                    title: nodeData._data.title,
                                    time: nodeData._data.start_time || '',
                                    duration: nodeData._data.duration_ms ? nodeData._data.duration_ms + 'ms' : '-',
                                    output: nodeData._data.output || '-',
                                    color: nodeData._data.type === 'INBOUND' ? 'text-blue-400' : nodeData._data.type === 'LLM' ? 'text-purple-400' : nodeData._data.type === 'TOOL' ? 'text-orange-400' : nodeData._data.type === 'OUTBOUND' ? 'text-green-400' : 'text-gray-400',
                                    agent_id: nodeData._data.agent_id
                                }
                            }
                            svgEl.selectAll('.node').classed('selected', false)
                            d3.select(this).classed('selected', true)
                        })
                    } catch(e) {
                        console.error('renderTraceGraph failed', e)
                    }
                }

                const loadGroupStatus = async () => {
                    try {
                        const res = await fetch('/api/v1/group/status')
                        groupStatus.value = await res.json()
                    } catch(e) { /* ignore */ }
                }

                const loadGroupMembers = async () => {
                    try {
                        const res = await fetch('/api/v1/group/members')
                        groupMembers.value = await res.json()
                    } catch(e) { /* ignore */ }
                }

                const toggleGroupPanel = async () => {
                    groupPanelVisible.value = !groupPanelVisible.value
                    if (groupPanelVisible.value) {
                        await loadGroupMembers()
                    }
                }

                const openTrace = async (event) => {
                    console.log('[trace] openTrace clicked', event?.trace_id || '')
                    tracePanelVisible.value = true
                    traceOpen.value = true
                    const traceId = event?.trace_id || ""
                    traceMeta.value = {
                        traceId: traceId,
                        channel: event?.classification || event?.sender_id || "unknown",
                    }
                    traceSpans.value = []
                    selectedSpan.value = null
                    if (!traceId) {
                        traceSpans.value = [{ id: "na", type: "INFO", title: "No trace id for this event", time: "", duration: "-", output: "-", color: "text-gray-400" }]
                        selectedSpan.value = traceSpans.value[0]
                        console.log('[trace] no trace id')
                        return
                    }
                    try {
                        console.log('[trace] load', traceId)
                        traceTaskInfo.value = null
                        tracePolicyDecisions.value = []
                        const res = await fetch(`/api/v1/trace/${encodeURIComponent(traceId)}`)
                        const data = await res.json()
                        const spans = (data.spans || []).sort((a, b) => a.time.localeCompare(b.time)).map((s) => ({
                            id: s.id,
                            type: s.type,
                            title: s.title,
                            time: s.time,
                            duration: s.duration || "",
                            output: s.output || "",
                            metadata: s.metadata || null,
                            color: s.type === "INBOUND" ? "text-blue-400"
                                : s.type === "OUTBOUND" ? "text-green-400"
                                : s.type === "LLM" ? "text-purple-400"
                                : s.type === "TOOL" ? "text-orange-400"
                                : "text-gray-400",
                        }))
                        traceSpans.value = spans
                        selectedSpan.value = null
                        // Load task info and policy decisions from enriched trace response
                        if (data.task) traceTaskInfo.value = data.task
                        if (data.policy_decisions) tracePolicyDecisions.value = data.policy_decisions
                        console.log('[trace] loaded', spans.length, 'task:', !!data.task, 'policy:', (data.policy_decisions || []).length)
                    } catch (e) {
                        console.error('Failed to load trace', e)
                    }
                }

                const hideTracePanel = () => {
                    console.log('[trace] hideTracePanel clicked')
                    tracePanelVisible.value = false
                    traceOpen.value = false
                }

                const toggleTracePanel = () => {
                    if (tracePanelVisible.value) {
                        hideTracePanel()
                    } else {
                        tracePanelVisible.value = true
                        traceOpen.value = true
                        if (!traceMeta.value.traceId) {
                            traceMeta.value = { traceId: "", channel: "" }
                            traceSpans.value = [{
                                id: "empty",
                                type: "INFO",
                                title: "No trace loaded \u2014 click a trace icon on a timeline message",
                                time: "",
                                duration: "-",
                                output: "-",
                                color: "text-gray-400"
                            }]
                            selectedSpan.value = traceSpans.value[0]
                        }
                    }
                }

                const startDragTrace = (e) => {
                    if (!traceFloating.value) return
                    draggingTrace.value = true
                    traceDragOffset.value = { x: e.clientX - tracePanel.value.x, y: e.clientY - tracePanel.value.y }
                }

                const startResizeTrace = (e) => {
                    if (!traceFloating.value) return
                    resizingTrace.value = true
                }

                const onTraceMouseMove = (e) => {
                    if (draggingTrace.value) {
                        tracePanel.value.x = Math.max(0, e.clientX - traceDragOffset.value.x)
                        tracePanel.value.y = Math.max(0, e.clientY - traceDragOffset.value.y)
                    }
                    if (resizingTrace.value) {
                        tracePanel.value.w = Math.max(320, e.clientX - tracePanel.value.x)
                        tracePanel.value.h = Math.max(280, e.clientY - tracePanel.value.y)
                    }
                }

                const stopTraceActions = () => {
                    draggingTrace.value = false
                    resizingTrace.value = false
                }

                const toggleTraceFloating = () => {
                    if (!traceFloating.value) {
                        if (tracePanelEl.value) {
                            const rect = tracePanelEl.value.getBoundingClientRect()
                            tracePanel.value = { x: rect.left, y: rect.top, w: rect.width, h: rect.height }
                        }
                        traceFloating.value = true
                    } else {
                        traceFloating.value = false
                    }
                }

                const saveConfig = async () => {
                    try {
                        configStatus.value = "Saving..."
                        const items = [
                            { key: "bot_repo_path", value: cfgBotRepoPath.value },
                            { key: "default_work_repo_path", value: cfgDefaultWorkRepoPath.value },
                            { key: "default_repo_search_path", value: cfgDefaultRepoSearchPath.value },
                            { key: "kafscale_lfs_proxy_url", value: cfgKafScaleProxyUrl.value },
                            { key: "default_auth_filter", value: cfgAuthFilterDefault.value || "authorized" },
                            { key: "whatsapp_pair_token", value: cfgWhatsAppToken.value },
                            { key: "whatsapp_allowlist", value: cfgWhatsAppAllowlist.value },
                            { key: "whatsapp_denylist", value: cfgWhatsAppDenylist.value },
                            { key: "whatsapp_pending", value: cfgWhatsAppPending.value },
                            { key: "daily_token_limit", value: String(cfgDailyTokenLimit.value || "0") },
                            { key: "max_auto_tier", value: String(cfgMaxAutoTier.value || "2") },
                        ]
                        for (const item of items) {
                            await fetch('/api/v1/settings', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(item),
                            })
                        }
                        identityRepoPath.value = cfgBotRepoPath.value
                        configStatus.value = "Saved"
                    } catch (e) {
                        console.error('Failed to save config', e)
                        configStatus.value = "Save failed"
                    }
                }

                const pickWorkRepo = async () => {
                    if (!window.showDirectoryPicker) {
                        webStatus.value = "Picker not supported"
                        return
                    }
                    try {
                        const handle = await window.showDirectoryPicker()
                        if (handle && handle.name) {
                            workRepoPath.value = handle.name
                            webStatus.value = "Picked folder name; paste full path"
                        }
                    } catch (e) {
                        webStatus.value = "Picker cancelled"
                    }
                }

                const splitList = (raw) => {
                    if (!raw) return []
                    return raw.split(/[\n,]+/).map(s => s.trim()).filter(Boolean)
                }

                const joinList = (list) => {
                    return list.join("\n")
                }

                const approvePending = () => {
                    const allow = new Set(splitList(cfgWhatsAppAllowlist.value))
                    const pending = splitList(cfgWhatsAppPending.value)
                    pending.forEach(p => allow.add(p))
                    cfgWhatsAppAllowlist.value = joinList([...allow])
                    cfgWhatsAppPending.value = ""
                }

                const denyPending = () => {
                    const deny = new Set(splitList(cfgWhatsAppDenylist.value))
                    const pending = splitList(cfgWhatsAppPending.value)
                    pending.forEach(p => deny.add(p))
                    cfgWhatsAppDenylist.value = joinList([...deny])
                    cfgWhatsAppPending.value = ""
                }

                const clearPending = () => {
                    cfgWhatsAppPending.value = ""
                }

                // Tasks panel methods
                const loadTasks = async () => {
                    try {
                        const params = new URLSearchParams()
                        if (tasksFilterStatus.value) params.set('status', tasksFilterStatus.value)
                        if (tasksFilterChannel.value) params.set('channel', tasksFilterChannel.value)
                        params.set('limit', '100')
                        const res = await fetch(`/api/v1/tasks?${params}`)
                        const data = await res.json()
                        tasksList.value = data || []
                    } catch (e) {
                        console.error('Failed to load tasks', e)
                    }
                }

                const toggleTasksPanel = () => {
                    tasksPanelVisible.value = !tasksPanelVisible.value
                    if (tasksPanelVisible.value) loadTasks()
                }

                const hideTasksPanel = () => {
                    tasksPanelVisible.value = false
                }

                // Memory Manager methods
                const loadMemoryStatus = async () => {
                    try {
                        const res = await fetch('/api/v1/memory/status')
                        if (!res.ok) throw new Error('Memory API error')
                        const data = await res.json()
                        memoryLayers.value = data.layers || []
                        memoryObserver.value = data.observer || { enabled: false, observation_count: 0, queue_depth: 0, last_observation: '' }
                        memoryER1.value = data.er1 || { connected: false, synced_count: 0, last_sync: '', url: '' }
                        memoryExpertise.value = data.expertise || []
                        memoryWorkingMemory.value = data.working_memory || { entries: 0, preview: '' }
                        memoryTotalChunks.value = data.totals?.total_chunks ?? 0
                        memoryMaxChunks.value = data.totals?.max_chunks ?? 50000
                    } catch (e) {
                        console.error('Failed to load memory status', e)
                    }
                }

                const toggleMemoryPanel = () => {
                    memoryPanelVisible.value = !memoryPanelVisible.value
                    if (memoryPanelVisible.value) loadMemoryStatus()
                }

                const hideMemoryPanel = () => {
                    memoryPanelVisible.value = false
                }

                const memoryResetLayer = (layerName) => {
                    memoryConfirmMessage.value = layerName === 'all'
                        ? 'This will delete ALL memory chunks across all layers. This cannot be undone.'
                        : `This will delete all chunks in the "${layerName}" memory layer. This cannot be undone.`
                    memoryConfirmCallback = async () => {
                        try {
                            const res = await fetch('/api/v1/memory/reset', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ layer: layerName })
                            })
                            const data = await res.json()
                            if (res.ok) {
                                memoryActionStatus.value = data.message || 'Reset complete'
                                memoryActionOk.value = true
                                await loadMemoryStatus()
                            } else {
                                memoryActionStatus.value = data.error || 'Reset failed'
                                memoryActionOk.value = false
                            }
                        } catch (e) {
                            memoryActionStatus.value = 'Network error'
                            memoryActionOk.value = false
                        }
                        setTimeout(() => { memoryActionStatus.value = '' }, 4000)
                    }
                    memoryConfirmVisible.value = true
                }

                const memoryResetAll = () => {
                    memoryResetLayer('all')
                }

                const memoryConfirmAction = () => {
                    memoryConfirmVisible.value = false
                    if (memoryConfirmCallback) memoryConfirmCallback()
                }

                const memoryPruneNow = async () => {
                    try {
                        const res = await fetch('/api/v1/memory/prune', { method: 'POST' })
                        const data = await res.json()
                        if (res.ok) {
                            memoryActionStatus.value = data.message || 'Pruning complete'
                            memoryActionOk.value = true
                            await loadMemoryStatus()
                        } else {
                            memoryActionStatus.value = data.error || 'Prune failed'
                            memoryActionOk.value = false
                        }
                    } catch (e) {
                        memoryActionStatus.value = 'Network error'
                        memoryActionOk.value = false
                    }
                    setTimeout(() => { memoryActionStatus.value = '' }, 4000)
                }

                // Filtering opacity logic
                const relatesToSelectedUser = (e) => {
                    if (!selectedUser.value) return true
                    if (!e) return false
                    const sel = String(selectedUser.value)
                    const selLower = sel.toLowerCase()
                    const sender = String(e.sender_id || '')
                    const senderLower = sender.toLowerCase()
                    if (sender === sel || senderLower === selLower) return true
                    // Normalize to compare bare IDs (strip @... if present)
                    const senderBare = sender.split('@')[0]
                    if (senderBare === sel) return true
                    const cls = String(e.classification || '').toLowerCase()
                    if (cls.includes(selLower)) return true
                    if (cls.includes((sel + '@s.whatsapp.net').toLowerCase())) return true
                    if (cls.includes((sel + '@lid').toLowerCase())) return true
                    return false
                }

                const isDimmed = (e) => {
                    // We filter out non-matching events entirely; no dimming.
                    return false
                }

                // Filter events based on authorization
                const filteredEvents = computed(() => {
                    return events.value.filter(e => {
                        if (!relatesToSelectedUser(e)) {
                            return false
                        }
                        if (!showTechnical.value && isTechnical(e) && !relatesToSelectedUser(e)) {
                            return false
                        }
                        if (authFilter.value === 'authorized') {
                            return e.authorized === true
                        } else if (authFilter.value === 'unauthorized') {
                            return e.authorized === false
                        }
                        return true // 'all'
                    })
                })

                const formatTime = (ts) => {
                    return new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' })
                }

                const getMediaUrl = (path) => {
                    if (!path) return ""
                    // Helper to convert absolute path to relative URL
                    // Assumes path contains "/media/"
                    if (path.includes('/media/')) {
                        const rel = path.split('/media/')[1]
                        return '/media/' + rel
                    }
                    // Fallback to filename if structure is unknown, but assume audio/
                    return '/media/audio/' + path.split('/').pop()
                }

                const isImage = (path) => {
                    if (!path) return false
                    const ext = path.split('.').pop().toLowerCase()
                    return ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)
                }

                const isAudio = (path) => {
                    if (!path) return false
                    const ext = path.split('.').pop().toLowerCase()
                    return ['mp3', 'ogg', 'wav', 'm4a'].includes(ext)
                }

                const isDocument = (path) => {
                    if (!path) return false
                    const ext = path.split('.').pop().toLowerCase()
                    return ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt', 'csv', 'zip', 'bin'].includes(ext)
                }

                const docExt = (path) => {
                    if (!path) return ''
                    return path.split('.').pop().toLowerCase()
                }

                const docIcon = (path) => {
                    const ext = docExt(path)
                    const icons = { pdf: '📕', doc: '📘', docx: '📘', xls: '📗', xlsx: '📗', ppt: '📙', pptx: '📙', txt: '📄', csv: '📊', zip: '📦' }
                    return icons[ext] || '📎'
                }

                const docIconClass = (path) => {
                    const ext = docExt(path)
                    const classes = { pdf: 'bg-red-900/40 border border-red-800', doc: 'bg-blue-900/40 border border-blue-800', docx: 'bg-blue-900/40 border border-blue-800', xls: 'bg-green-900/40 border border-green-800', xlsx: 'bg-green-900/40 border border-green-800' }
                    return classes[ext] || 'bg-gray-800 border border-gray-700'
                }

                onMounted(() => {
                    configOpen.value = false
                    tracePanelVisible.value = false
                    traceOpen.value = false
                    traceMeta.value = { traceId: "", channel: "" }
                    traceSpans.value = []
                    selectedSpan.value = null
                    fetchSetting("default_auth_filter").then((v) => {
                        if (v) authFilter.value = v
                    }).catch(() => { })
                    fetchSetting("bot_repo_path").then((v) => {
                        if (v) identityRepoPath.value = v
                    }).catch(() => { })
                    const storedRepoVisible = localStorage.getItem('kafclaw_repo_panel_visible')
                    if (storedRepoVisible === 'true') repoPanelVisible.value = true
                    if (storedRepoVisible === 'false') repoPanelVisible.value = false
                    const storedIdentityVisible = localStorage.getItem('kafclaw_identity_panel_visible')
                    if (storedIdentityVisible === 'true') identityPanelVisible.value = true
                    if (storedIdentityVisible === 'false') identityPanelVisible.value = false
                    fetchData()
                    loadSilentMode()
                    loadWebUsers()
                    loadClipboard()
                    loadWorkRepo()
                    loadRepoOptions()
                    loadDefaultWorkRepoPath()
                    fetchSetting("selected_repo_path").then((v) => {
                        if (v) {
                            selectedRepoPath.value = v
                            workRepoPath.value = v
                        }
                    }).catch(() => { })
                    refreshRepo()
                    setInterval(fetchData, 5000)
                    setInterval(refreshRepo, 5000)
                    fetch('/api/v1/status').then(r => r.json()).then(d => { appMode.value = d.mode || '' }).catch(() => {})
                    loadGroupStatus()
                    setInterval(loadGroupStatus, 30000)
                    window.addEventListener('mousemove', onRepoMouseMove)
                    window.addEventListener('mouseup', stopRepoActions)
                    window.addEventListener('mousemove', onTraceMouseMove)
                    window.addEventListener('mouseup', stopTraceActions)
                })

                const startDragRepo = (e) => {
                    if (!repoFloating.value) return
                    draggingRepo.value = true
                    dragOffset.value = { x: e.clientX - repoPanel.value.x, y: e.clientY - repoPanel.value.y }
                }

                const startResizeRepo = (e) => {
                    if (!repoFloating.value) return
                    resizingRepo.value = true
                }

                const onRepoMouseMove = (e) => {
                    if (draggingRepo.value) {
                        repoPanel.value.x = Math.max(0, e.clientX - dragOffset.value.x)
                        repoPanel.value.y = Math.max(0, e.clientY - dragOffset.value.y)
                    }
                    if (resizingRepo.value) {
                        const minW = 360
                        const minH = 320
                        repoPanel.value.w = Math.max(minW, e.clientX - repoPanel.value.x)
                        repoPanel.value.h = Math.max(minH, e.clientY - repoPanel.value.y)
                    }
                }

                const stopRepoActions = () => {
                    draggingRepo.value = false
                    resizingRepo.value = false
                }

                const toggleRepoFloating = () => {
                    if (!repoFloating.value) {
                        // Switch to floating: keep last floating size, avoid full-width takeover
                        if (repoPanelEl.value) {
                            const rect = repoPanelEl.value.getBoundingClientRect()
                            const maxW = Math.min(560, rect.width)
                            const maxH = Math.min(700, rect.height)
                            if (repoFloatState.value) {
                                repoPanel.value = { x: rect.left, y: rect.top, w: repoPanel.value.w, h: repoPanel.value.h }
                            } else {
                                repoPanel.value = { x: rect.left, y: rect.top, w: maxW, h: maxH }
                            }
                        }
                        repoFloating.value = true
                        repoFloatState.value = true
                    } else {
                        // Dock: return to layout sizing
                        repoFloating.value = false
                    }
                }

                const repoInitialized = computed(() => !repoStatusError.value || !repoStatusError.value.includes('not a git repository'))
                const repoHealthClass = computed(() => repoInitialized.value ? 'text-gray-300' : 'text-yellow-400')
                const repoHealthLabel = computed(() => repoInitialized.value ? 'Repo OK' : 'Not initialized')
                const repoHealthText = computed(() => {
                    if (!repoInitialized.value) return ''
                    const s = repoStatus.value || ''
                    if (s.includes('CONFLICT') || s.includes('UU') || s.includes('unmerged')) return 'Conflicts'
                    if (s.includes('nothing to commit')) return 'Clean'
                    const lines = s.trim().split('\n').filter(Boolean)
                    if (lines.length <= 1 && lines[0]?.startsWith('##')) return 'Clean'
                    return 'Uncommitted'
                })
                const repoHealthDot = computed(() => {
                    if (!repoInitialized.value) return 'bg-yellow-500'
                    const s = repoStatus.value || ''
                    if (s.includes('CONFLICT') || s.includes('UU') || s.includes('unmerged')) return 'bg-red-500'
                    if (s.includes('nothing to commit')) return 'bg-green-500'
                    const lines = s.trim().split('\n').filter(Boolean)
                    if (lines.length <= 1 && lines[0]?.startsWith('##')) return 'bg-green-500'
                    return 'bg-yellow-500'
                })
                const repoHasRemote = computed(() => (repoRemoteInfo.value || '').trim() !== '')
                // Parse git status to find changed file paths
                const changedFiles = computed(() => {
                    const s = repoStatus.value || ''
                    const files = new Set()
                    for (const line of s.split('\n')) {
                        if (!line || line.startsWith('##')) continue
                        const match = line.match(/^.{2}\s+(.+?)(?:\s+->\s+(.+))?$/)
                        if (match) {
                            files.add(match[2] || match[1])
                            if (match[2]) files.add(match[1])
                        }
                    }
                    return files
                })
                const isItemChanged = (item) => {
                    if (changedFiles.value.has(item.path)) return true
                    if (item.type === 'dir') {
                        const prefix = item.path + '/'
                        for (const f of changedFiles.value) {
                            if (f.startsWith(prefix)) return true
                        }
                    }
                    return false
                }
                // Identity repo computed properties
                const idRepoInitialized = computed(() => !idRepoStatusError.value || !idRepoStatusError.value.includes('not a git repository'))
                const idRepoHealthClass = computed(() => idRepoInitialized.value ? 'text-gray-300' : 'text-yellow-400')
                const idRepoHealthLabel = computed(() => idRepoInitialized.value ? 'Repo OK' : 'Not initialized')
                const idRepoHealthText = computed(() => {
                    if (!idRepoInitialized.value) return ''
                    const s = idRepoStatus.value || ''
                    if (s.includes('CONFLICT') || s.includes('UU') || s.includes('unmerged')) return 'Conflicts'
                    if (s.includes('nothing to commit')) return 'Clean'
                    const lines = s.trim().split('\n').filter(Boolean)
                    if (lines.length <= 1 && lines[0]?.startsWith('##')) return 'Clean'
                    return 'Uncommitted'
                })
                const idRepoHealthDot = computed(() => {
                    if (!idRepoInitialized.value) return 'bg-yellow-500'
                    const s = idRepoStatus.value || ''
                    if (s.includes('CONFLICT') || s.includes('UU') || s.includes('unmerged')) return 'bg-red-500'
                    if (s.includes('nothing to commit')) return 'bg-green-500'
                    const lines = s.trim().split('\n').filter(Boolean)
                    if (lines.length <= 1 && lines[0]?.startsWith('##')) return 'bg-green-500'
                    return 'bg-yellow-500'
                })
                const idRepoHasRemote = computed(() => (idRepoRemoteInfo.value || '').trim() !== '')
                const idChangedFiles = computed(() => {
                    const s = idRepoStatus.value || ''
                    const files = new Set()
                    for (const line of s.split('\n')) {
                        if (!line || line.startsWith('##')) continue
                        const match = line.match(/^.{2}\s+(.+?)(?:\s+->\s+(.+))?$/)
                        if (match) {
                            files.add(match[2] || match[1])
                            if (match[2]) files.add(match[1])
                        }
                    }
                    return files
                })
                const isIdItemChanged = (item) => {
                    if (idChangedFiles.value.has(item.path)) return true
                    if (item.type === 'dir') {
                        const prefix = item.path + '/'
                        for (const f of idChangedFiles.value) {
                            if (f.startsWith(prefix)) return true
                        }
                    }
                    return false
                }
                const bothPanelsVisible = computed(() => identityPanelVisible.value && repoPanelVisible.value)

                return { events, filteredEvents, selectedUser, authFilter, silentMode, toggleSilent, senders, isBot, isTechnical, getDotClass, fetchData, formatTime, getMediaUrl, isDimmed, isImage, isAudio, isDocument, docIcon, docIconClass, docExt, webUsers, selectedWebUserId, newWebUserName, linkJid, webChatMessage, webStatus, systemCopyStatus, forceSend, showTechnical, loadWebUsers, createWebUser, loadWebLink, saveWebLink, unlinkWebLink, sendWebChat, saveForceSend, copyWebChat, copyMessage, copyMessageSystem, reprocessMessage, clipboardOpen, clipboardItems, clipboardSelected, toggleClipboard, selectAllClipboard, clearClipboard, deleteSelectedClipboard, copySelectedClipboard, removeClipboardItem, workRepoPath, loadWorkRepo, saveWorkRepo, pickWorkRepo, repoOptions, selectedRepoPath, defaultWorkRepoPath, activeRepoChoice, repoScanStatus, loadRepoOptions, loadDefaultWorkRepoPath, useSelectedRepo, useDefaultRepo, repoTree, repoFileContent, repoFileDiff, repoDiff, repoStatus, repoStatusError, repoRemoteInfo, repoCommitMessage, repoRemoteUrl, ghAuthStatus, repoBranches, selectedBranch, repoCommits, prTitle, prBody, prBase, prHead, prDraft, repoTab, repoInitialized, repoHealthClass, repoHealthLabel, repoHealthText, repoHealthDot, repoHasRemote, changedFiles, isItemChanged, refreshRepo, refreshAll, loadRepoTree, selectRepoItem, loadRepoStatus, loadRepoDiff, loadRepoLog, loadRepoBranches, checkoutBranch, loadGhAuth, commitRepo, pullRepo, pushRepo, initRepo, createPr, repoActionStatus, repoActionOk, repoActionAt, repoHover, repoHoverStyle, showRepoTooltip, hideRepoTooltip, repoPanelVisible, identityPanelVisible, toggleRepoPanel, toggleIdentityPanel, showRepoPanel, hideRepoPanel, hideIdentityPanel, repoFloating, repoPanel, repoFloatState, startDragRepo, startResizeRepo, toggleRepoFloating, repoPanelEl, identityPanel, identityPanelEl, identityFloating, configOpen, configStatus, configTab, configTabs, cfgBotRepoPath, identityRepoPath, cfgDefaultWorkRepoPath, cfgDefaultRepoSearchPath, cfgKafScaleProxyUrl, cfgAuthFilterDefault, cfgWhatsAppToken, cfgWhatsAppAllowlist, cfgWhatsAppDenylist, cfgWhatsAppPending, approvePending, denyPending, clearPending, openConfig, closeConfig, saveConfig, traceOpen, tracePanelVisible, traceMeta, traceSpans, selectedSpan, traceFloating, tracePanel, tracePanelEl, openTrace, hideTracePanel, toggleTracePanel, startDragTrace, startResizeTrace, toggleTraceFloating, spanTypeColorHex, bothPanelsVisible, idRepoTree, idRepoFileContent, idRepoFileDiff, idRepoDiff, idRepoStatus, idRepoStatusError, idRepoRemoteInfo, idRepoCommitMessage, idRepoRemoteUrl, idGhAuthStatus, idRepoBranches, idSelectedBranch, idRepoCommits, idPrTitle, idPrBody, idPrBase, idPrHead, idPrDraft, idRepoTab, idRepoActionStatus, idRepoActionOk, idRepoActionAt, idRepoInitialized, idRepoHealthClass, idRepoHealthLabel, idRepoHealthText, idRepoHealthDot, idRepoHasRemote, idChangedFiles, isIdItemChanged, refreshIdentity, loadIdRepoTree, selectIdRepoItem, loadIdRepoStatus, loadIdRepoDiff, loadIdRepoLog, loadIdRepoBranches, checkoutIdBranch, loadIdGhAuth, commitIdRepo, pullIdRepo, pushIdRepo, initIdRepo, createIdPr, tasksPanelVisible, tasksList, selectedTask, tasksFilterStatus, tasksFilterChannel, loadTasks, toggleTasksPanel, hideTasksPanel, cfgDailyTokenLimit, cfgMaxAutoTier, traceTaskInfo, tracePolicyDecisions, traceJsonCopied, copyTraceJson, traceViewMode, traceGraphSvg, groupPanelVisible, groupStatus, groupMembers, renderTraceGraph, loadGroupStatus, loadGroupMembers, toggleGroupPanel, switchMode, appMode, memoryPanelVisible, memoryLayers, memoryObserver, memoryER1, memoryExpertise, memoryWorkingMemory, memoryTotalChunks, memoryMaxChunks, memoryUsagePercent, memoryActionStatus, memoryActionOk, memoryConfirmVisible, memoryConfirmMessage, loadMemoryStatus, toggleMemoryPanel, hideMemoryPanel, memoryResetLayer, memoryResetAll, memoryConfirmAction, memoryPruneNow }
            }
        })
        app.component('github-panel', GithubPanel)
        app.mount('#app')
    </script>
</body>

</html>
