# KafClaw Workshop: KafScale platform + 3 headless agents
#
# Infrastructure: MinIO (local S3) → etcd → KafScale broker → KafScale LFS Proxy
# Agents: 3 headless workers connecting via Kafka protocol + LFS HTTP API
#
# Usage:
#   cp .env.example .env   # fill in your values
#   make workshop-up       # or: docker compose -f docker-compose.group.yml up -d
#
# The Mac Electron app runs separately as the 4th agent (desktop-orchestrator)
# and connects to the same KafScale broker at localhost:9092.
#
# Ports exposed to host:
#   - 9000/9001  MinIO S3 API / Console
#   - 2379       etcd
#   - 9092       KafScale broker (Kafka protocol)
#   - 8080       KafScale LFS Proxy (HTTP API)
#   - 3080       KafScale Console

services:

  # ==========================================================================
  # Infrastructure
  # ==========================================================================

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - kafclaw

  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 minioadmin minioadmin;
      mc mb local/kafscale --ignore-existing;
      mc anonymous set download local/kafscale;
      echo 'Bucket kafscale ready';
      exit 0;
      "
    networks:
      - kafclaw

  etcd:
    image: quay.io/coreos/etcd:v3.5.12
    command:
      - etcd
      - --name=etcd0
      - --data-dir=/etcd-data
      - --advertise-client-urls=http://etcd:2379
      - --listen-client-urls=http://0.0.0.0:2379
      - --initial-advertise-peer-urls=http://etcd:2380
      - --listen-peer-urls=http://0.0.0.0:2380
      - --initial-cluster=etcd0=http://etcd:2380
      - --initial-cluster-state=new
      - --initial-cluster-token=kafclaw-workshop
    ports:
      - "2379:2379"
    volumes:
      - etcd-data:/etcd-data
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - kafclaw

  # ==========================================================================
  # KafScale Platform
  # ==========================================================================

  broker:
    image: ${KAFSCALE_REGISTRY:-ghcr.io/kafscale}/kafscale-broker:${KAFSCALE_TAG:-dev}
    depends_on:
      etcd:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    environment:
      KAFSCALE_BROKER_ID: "0"
      KAFSCALE_BROKER_ADDR: ":9092"
      KAFSCALE_BROKER_HOST: "broker"
      KAFSCALE_BROKER_PORT: "9092"
      KAFSCALE_BROKER_ETCD_ENDPOINTS: "http://etcd:2379"
      KAFSCALE_BROKER_DATA_DIR: "/data"
      KAFSCALE_BROKER_LOG_LEVEL: "info"
      # S3 — local MinIO
      KAFSCALE_S3_BUCKET: "kafscale"
      KAFSCALE_S3_REGION: "us-east-1"
      KAFSCALE_S3_ENDPOINT: "http://minio:9000"
      KAFSCALE_S3_ACCESS_KEY: "minioadmin"
      KAFSCALE_S3_SECRET_KEY: "minioadmin"
      KAFSCALE_S3_PATH_STYLE: "true"
    ports:
      - "9092:9092"
    volumes:
      - broker-data:/data
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 9092 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - kafclaw

  lfs-proxy:
    image: ${KAFSCALE_REGISTRY:-ghcr.io/kafscale}/kafscale-lfs-proxy:${KAFSCALE_TAG:-dev}
    depends_on:
      etcd:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
      broker:
        condition: service_healthy
    environment:
      # Kafka proxy
      KAFSCALE_LFS_PROXY_ADDR: ":9093"
      KAFSCALE_LFS_PROXY_ADVERTISED_HOST: "lfs-proxy"
      KAFSCALE_LFS_PROXY_ADVERTISED_PORT: "9093"
      KAFSCALE_LFS_PROXY_ETCD_ENDPOINTS: "http://etcd:2379"
      KAFSCALE_LFS_PROXY_BACKENDS: "broker:9092"
      # HTTP API
      KAFSCALE_LFS_PROXY_HTTP_ADDR: ":8080"
      # Health & Metrics
      KAFSCALE_LFS_PROXY_HEALTH_ADDR: ":9094"
      KAFSCALE_LFS_PROXY_METRICS_ADDR: ":9095"
      # S3 — local MinIO
      KAFSCALE_LFS_PROXY_S3_BUCKET: "kafscale"
      KAFSCALE_LFS_PROXY_S3_REGION: "us-east-1"
      KAFSCALE_LFS_PROXY_S3_ENDPOINT: "http://minio:9000"
      KAFSCALE_LFS_PROXY_S3_ACCESS_KEY: "minioadmin"
      KAFSCALE_LFS_PROXY_S3_SECRET_KEY: "minioadmin"
      KAFSCALE_LFS_PROXY_S3_FORCE_PATH_STYLE: "true"
      KAFSCALE_LFS_PROXY_S3_ENSURE_BUCKET: "true"
      # Blob settings
      KAFSCALE_LFS_PROXY_MAX_BLOB_SIZE: "1073741824"  # 1GB (workshop)
      KAFSCALE_LFS_PROXY_CHUNK_SIZE: "16777216"        # 16MB
      # Logging
      KAFSCALE_LFS_PROXY_LOG_LEVEL: "info"
      # Traceability
      KAFSCALE_LFS_TRACKER_ENABLED: "true"
      KAFSCALE_LFS_TRACKER_TOPIC: "__lfs_ops_state"
      KAFSCALE_LFS_TRACKER_ENSURE_TOPIC: "true"
      KAFSCALE_LFS_TRACKER_PARTITIONS: "1"
      KAFSCALE_LFS_TRACKER_REPLICATION_FACTOR: "1"
    ports:
      - "8080:8080"
      - "9093:9093"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:9094/readyz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - kafclaw

  console:
    image: ${KAFSCALE_REGISTRY:-ghcr.io/kafscale}/kafscale-console:${KAFSCALE_TAG:-dev}
    depends_on:
      etcd:
        condition: service_healthy
      broker:
        condition: service_healthy
    environment:
      KAFSCALE_CONSOLE_HTTP_ADDR: ":3080"
      KAFSCALE_CONSOLE_ETCD_ENDPOINTS: "http://etcd:2379"
      KAFSCALE_CONSOLE_BROKER_METRICS_URL: "http://broker:8080/metrics"
      KAFSCALE_CONSOLE_LOG_LEVEL: "info"
      KAFSCALE_UI_USERNAME: "kafscaleadmin"
      KAFSCALE_UI_PASSWORD: "kafscale"
      # LFS dashboard
      KAFSCALE_CONSOLE_LFS_ENABLED: "true"
      KAFSCALE_CONSOLE_KAFKA_BROKERS: "broker:9092"
      KAFSCALE_LFS_TRACKER_TOPIC: "__lfs_ops_state"
      KAFSCALE_CONSOLE_LFS_S3_BUCKET: "kafscale"
      KAFSCALE_CONSOLE_LFS_S3_REGION: "us-east-1"
      KAFSCALE_CONSOLE_LFS_S3_ENDPOINT: "http://minio:9000"
      KAFSCALE_CONSOLE_LFS_S3_ACCESS_KEY: "minioadmin"
      KAFSCALE_CONSOLE_LFS_S3_SECRET_KEY: "minioadmin"
      KAFSCALE_CONSOLE_LFS_S3_PRESIGN_TTL: "300"
    ports:
      - "3080:3080"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3080/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - kafclaw

  # ==========================================================================
  # KafClaw Headless Agents
  # ==========================================================================

  agent-researcher:
    image: kafclaw:local
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      MIKROBOT_GROUP_ENABLED: "true"
      MIKROBOT_GROUP_GROUP_NAME: "${GROUP_NAME:-workshop}"
      MIKROBOT_GROUP_AGENT_ID: "agent-researcher"
      MIKROBOT_GROUP_KAFKA_BROKERS: "broker:9092"
      MIKROBOT_GROUP_KAFSCALE_LFS_PROXY_URL: "http://lfs-proxy:8080"
      MIKROBOT_AGENTS_WORK_REPO_PATH: "/opt/work-repo"
      MIKROBOT_AGENTS_WORKSPACE: "/opt/workspace"
      MIKROBOT_AGENTS_SYSTEM_REPO_PATH: "/opt/system-repo"
      MIKROBOT_GATEWAY_HOST: "0.0.0.0"
      MIKROBOT_GATEWAY_AUTH_TOKEN: "${AGENT_AUTH_TOKEN}"
      MIKROBOT_ORCHESTRATOR_ENABLED: "true"
      MIKROBOT_ORCHESTRATOR_ROLE: "worker"
      OPENROUTER_API_KEY: "${OPENROUTER_API_KEY}"
      WORK_REPO_GIT_URL: "${AGENT1_WORK_REPO_GIT_URL:-}"
    volumes:
      - ${AGENT1_WORK_REPO:-./volumes/agent-researcher/work-repo}:/opt/work-repo
      - ${AGENT1_WORKSPACE:-./examples/workshop/agent-researcher/workspace}:/opt/workspace
      - ./:/opt/system-repo:ro
    depends_on:
      broker:
        condition: service_healthy
      lfs-proxy:
        condition: service_healthy
    networks:
      - kafclaw

  agent-coder:
    image: kafclaw:local
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      MIKROBOT_GROUP_ENABLED: "true"
      MIKROBOT_GROUP_GROUP_NAME: "${GROUP_NAME:-workshop}"
      MIKROBOT_GROUP_AGENT_ID: "agent-coder"
      MIKROBOT_GROUP_KAFKA_BROKERS: "broker:9092"
      MIKROBOT_GROUP_KAFSCALE_LFS_PROXY_URL: "http://lfs-proxy:8080"
      MIKROBOT_AGENTS_WORK_REPO_PATH: "/opt/work-repo"
      MIKROBOT_AGENTS_WORKSPACE: "/opt/workspace"
      MIKROBOT_AGENTS_SYSTEM_REPO_PATH: "/opt/system-repo"
      MIKROBOT_GATEWAY_HOST: "0.0.0.0"
      MIKROBOT_GATEWAY_AUTH_TOKEN: "${AGENT_AUTH_TOKEN}"
      MIKROBOT_ORCHESTRATOR_ENABLED: "true"
      MIKROBOT_ORCHESTRATOR_ROLE: "worker"
      OPENROUTER_API_KEY: "${OPENROUTER_API_KEY}"
      WORK_REPO_GIT_URL: "${AGENT2_WORK_REPO_GIT_URL:-}"
    volumes:
      - ${AGENT2_WORK_REPO:-./volumes/agent-coder/work-repo}:/opt/work-repo
      - ${AGENT2_WORKSPACE:-./examples/workshop/agent-coder/workspace}:/opt/workspace
      - ./:/opt/system-repo:ro
    depends_on:
      broker:
        condition: service_healthy
      lfs-proxy:
        condition: service_healthy
    networks:
      - kafclaw

  agent-reviewer:
    image: kafclaw:local
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      MIKROBOT_GROUP_ENABLED: "true"
      MIKROBOT_GROUP_GROUP_NAME: "${GROUP_NAME:-workshop}"
      MIKROBOT_GROUP_AGENT_ID: "agent-reviewer"
      MIKROBOT_GROUP_KAFKA_BROKERS: "broker:9092"
      MIKROBOT_GROUP_KAFSCALE_LFS_PROXY_URL: "http://lfs-proxy:8080"
      MIKROBOT_AGENTS_WORK_REPO_PATH: "/opt/work-repo"
      MIKROBOT_AGENTS_WORKSPACE: "/opt/workspace"
      MIKROBOT_AGENTS_SYSTEM_REPO_PATH: "/opt/system-repo"
      MIKROBOT_GATEWAY_HOST: "0.0.0.0"
      MIKROBOT_GATEWAY_AUTH_TOKEN: "${AGENT_AUTH_TOKEN}"
      MIKROBOT_ORCHESTRATOR_ENABLED: "true"
      MIKROBOT_ORCHESTRATOR_ROLE: "worker"
      OPENROUTER_API_KEY: "${OPENROUTER_API_KEY}"
      WORK_REPO_GIT_URL: "${AGENT3_WORK_REPO_GIT_URL:-}"
    volumes:
      - ${AGENT3_WORK_REPO:-./volumes/agent-reviewer/work-repo}:/opt/work-repo
      - ${AGENT3_WORKSPACE:-./examples/workshop/agent-reviewer/workspace}:/opt/workspace
      - ./:/opt/system-repo:ro
    depends_on:
      broker:
        condition: service_healthy
      lfs-proxy:
        condition: service_healthy
    networks:
      - kafclaw

volumes:
  minio-data:
  etcd-data:
  broker-data:

networks:
  kafclaw:
    driver: bridge
